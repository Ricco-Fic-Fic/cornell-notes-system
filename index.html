<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cornell Notes System - Gemini AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 1.1em;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: linear-gradient(45deg, #f8fafc, #f1f5f9);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            margin: 20px 0;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: linear-gradient(45deg, #eef2ff, #e0e7ff);
            transform: translateY(-2px);
        }

        .upload-area.drag-over {
            border-color: #667eea;
            background: linear-gradient(45deg, #eef2ff, #ddd6fe);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #667eea;
        }

        .upload-area h3 {
            color: #374151;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .upload-area p {
            color: #6b7280;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #374151 100%);
            box-shadow: 0 5px 15px rgba(107, 114, 128, 0.4);
        }

        .btn-secondary:hover:not(:disabled) {
            box-shadow: 0 10px 25px rgba(107, 114, 128, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-success:hover:not(:disabled) {
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.6);
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .image-item {
            position: relative;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .image-item:hover {
            transform: translateY(-5px);
        }

        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .image-item .image-name {
            padding: 10px;
            font-size: 0.9em;
            color: #374151;
            background: #f9fafb;
        }

        .remove-image {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .remove-image:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .hidden {
            display: none;
        }

        .cornell-preview {
            background: #f7c948;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #d69e2e;
        }

        .cornell-header {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            padding: 15px;
            background: #eab308;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
            color: #451a03;
            font-weight: bold;
        }

        .cornell-body {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            min-height: 300px;
        }

        .cornell-left {
            background: rgba(255, 255, 255, 0.3);
            padding: 15px;
            border-radius: 8px;
        }

        .cornell-main {
            background: rgba(255, 255, 255, 0.5);
            padding: 15px;
            border-radius: 8px;
        }

        .cornell-summary {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.4);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-content {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .cornell-header {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .cornell-body {
                grid-template-columns: 1fr;
            }

            .status-bar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Cornell Notes System</h1>
            <p>Syst√®me de prise de notes intelligent avec IA Gemini</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator"></div>
                <span><strong>Gemini AI :</strong> Op√©rationnel</span>
            </div>
            <div class="status-item">
                <span><strong>Co√ªt :</strong> 0‚Ç¨/mois (Gratuit)</span>
            </div>
            <div class="status-item">
                <span><strong>OCR Vision :</strong> Activ√©</span>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="upload">üì§ Upload & Configuration</div>
            <div class="tab" data-tab="cornell">üìã Cornell Notes</div>
            <div class="tab" data-tab="export">üìÑ Export PDF</div>
            <div class="tab" data-tab="info">‚ÑπÔ∏è Informations</div>
        </div>

        <!-- ONGLET 1: Upload & Configuration -->
        <div class="tab-content active" id="upload">
            <h2>üìÅ Configuration du Cours</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>üìÖ Date *</label>
                    <input type="date" id="courseDate" required>
                </div>
                <div class="form-group">
                    <label>üìö Mati√®re *</label>
                    <select id="courseSubject" required>
                        <option value="">S√©lectionnez une mati√®re</option>
                        <option value="math√©matiques">Math√©matiques</option>
                        <option value="physique">Physique</option>
                        <option value="chimie">Chimie</option>
                        <option value="biologie">Biologie</option>
                        <option value="histoire">Histoire</option>
                        <option value="g√©ographie">G√©ographie</option>
                        <option value="fran√ßais">Fran√ßais</option>
                        <option value="philosophie">Philosophie</option>
                        <option value="√©conomie">√âconomie</option>
                        <option value="comptabilit√©">Comptabilit√©</option>
                        <option value="droit">Droit</option>
                        <option value="anglais">Anglais</option>
                        <option value="allemand">Allemand</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üë®‚Äçüè´ Professeur</label>
                    <input type="text" id="courseProfessor" placeholder="Nom du professeur">
                </div>
                <div class="form-group">
                    <label>üìñ Chapitre *</label>
                    <input type="text" id="courseChapter" placeholder="Ex: Chap.3 Politique Mon√©taire" required>
                </div>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì§</div>
                <h3>D√©posez vos notes GoodNotes ici</h3>
                <p>PDF, JPG, PNG, WEBP (max 5MB par fichier)</p>
                <input type="file" id="fileInput" multiple accept=".pdf,image/*" style="display: none;">
                <button type="button" class="btn" onclick="document.getElementById('fileInput').click()">
                    Choisir des fichiers
                </button>
            </div>
            
            <div id="uploadStatus" class="hidden"></div>
            <div id="imagePreview" style="margin: 20px 0;"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button type="button" class="btn" id="analyzeBtn" onclick="analyzeWithGeminiVision()" disabled>
                    ü§ñ Analyser avec Gemini Vision
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    üîÑ R√©initialiser
                </button>
            </div>
            
            <div id="analysisStatus" class="hidden"></div>
        </div>

        <!-- ONGLET 2: Cornell Notes -->
        <div class="tab-content" id="cornell">
            <h2>üìã Structure Cornell Enrichie</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üîë Mots-cl√©s extraits</label>
                    <textarea id="keywords" rows="3" readonly style="background: #f8fafc;"></textarea>
                </div>
                <div class="form-group">
                    <label>üßÆ Formules identifi√©es</label>
                    <textarea id="formulas" rows="3" readonly style="background: #f8fafc;"></textarea>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üë®‚Äçüéì Auteurs/Personnages</label>
                    <textarea id="authors" rows="2" readonly style="background: #f8fafc;"></textarea>
                </div>
                <div class="form-group">
                    <label>üìÖ Dates importantes</label>
                    <textarea id="dates" rows="2" readonly style="background: #f8fafc;"></textarea>
                </div>
            </div>
            
            <div class="form-group">
                <label>‚ùì Questions identifi√©es</label>
                <textarea id="doubts" rows="2" readonly style="background: #f8fafc;"></textarea>
            </div>
            
            <div class="form-group">
                <label>üìÑ Synth√®se principale (modifiable)</label>
                <textarea id="mainNotes" rows="8" placeholder="Synth√®se g√©n√©r√©e par Gemini AI..."></textarea>
            </div>
            
            <div class="form-group">
                <label>üìù R√©sum√© personnel (modifiable)</label>
                <textarea id="summary" rows="4" placeholder="R√©sum√© enrichi par IA..."></textarea>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button type="button" class="btn" onclick="enrichWithGeminiAI()">
                    ‚ú® Enrichir avec Gemini AI
                </button>
                <button type="button" class="btn btn-secondary" onclick="previewCornell()">
                    üëÅÔ∏è Aper√ßu Cornell
                </button>
            </div>
            
            <div id="enrichmentStatus" class="hidden"></div>
        </div>

        <!-- ONGLET 3: Export PDF -->
        <div class="tab-content" id="export">
            <h2>üìÑ Export PDF Cornell</h2>
            
            <div style="text-align: center; margin: 40px 0;">
                <button type="button" class="btn" onclick="generatePDF()" disabled id="exportBtn">
                    üìÑ G√©n√©rer PDF Cornell
                </button>
            </div>
            
            <div id="exportStatus" class="hidden"></div>
            
            <div style="margin-top: 40px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                <h3>üìä Statistiques d'usage</h3>
                <div id="usageStats">
                    <p><strong>R√©sum√©s cr√©√©s :</strong> <span id="totalSummaries">0</span></p>
                    <p><strong>Co√ªt :</strong> <span id="monthlyCost">0,00‚Ç¨ (Gratuit)</span></p>
                    <p><strong>Analyses effectu√©es :</strong> <span id="tokensUsed">0</span></p>
                </div>
            </div>
        </div>

        <!-- ONGLET 4: Informations -->
        <div class="tab-content" id="info">
            <h2>‚ÑπÔ∏è Informations Syst√®me</h2>
            
            <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>ü§ñ IA Gemini</h3>
                <p><strong>Statut :</strong> Op√©rationnel</p>
                <p><strong>Mod√®le :</strong> Gemini 2.0 Flash</p>
                <p><strong>Fonctionnalit√©s :</strong> OCR Vision + Enrichissement</p>
                <p><strong>Co√ªt :</strong> Gratuit (quota Google AI)</p>
            </div>

            <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>üìã M√©thode Cornell</h3>
                <p>La m√©thode Cornell divise la page en trois sections :</p>
                <ul style="margin: 10px 0 0 20px;">
                    <li><strong>Colonne de gauche :</strong> Mots-cl√©s, formules, questions</li>
                    <li><strong>Zone principale :</strong> Prise de notes d√©taill√©e</li>
                    <li><strong>R√©sum√© :</strong> Synth√®se personnelle en bas</li>
                </ul>
            </div>

            <div style="background: #fef3c7; padding: 20px; border-radius: 8px;">
                <h3>üöÄ Workflow</h3>
                <ol style="margin: 10px 0 0 20px;">
                    <li>Uploadez vos notes GoodNotes (PDF/images)</li>
                    <li>L'IA Gemini extrait automatiquement le contenu</li>
                    <li>Enrichissement intelligent du contenu</li>
                    <li>Export au format PDF Cornell</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- PDF.js pour conversion PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script>
        // Configuration PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Variables globales
        let uploadedImages = [];
        let processedData = null;

        // Gestion des onglets
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                // D√©sactiver tous les onglets
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Activer l'onglet s√©lectionn√©
                tab.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // Initialisation de la date
        document.getElementById('courseDate').valueAsDate = new Date();

        // Gestion du drag & drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false);
        });

        uploadArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFileSelect, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            [...files].forEach(uploadFile);
        }

        function uploadFile(file) {
            if (file.size > 5 * 1024 * 1024) {
                showStatus('Fichier trop volumineux (max 5MB)', 'error', 'uploadStatus');
                return;
            }

            if (file.type === 'application/pdf') {
                convertPDFToImages(file);
            } else if (file.type.startsWith('image/')) {
                processImageFile(file);
            } else {
                showStatus('Type de fichier non support√©', 'error', 'uploadStatus');
            }
        }

        function convertPDFToImages(file) {
            showStatus('Conversion PDF en cours...', 'info', 'uploadStatus');
            
            const fileReader = new FileReader();
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                
                pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                    const maxPages = Math.min(pdf.numPages, 5);
                    
                    for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
                        pdf.getPage(pageNum).then(function(page) {
                            const scale = 2.0;
                            const viewport = page.getViewport({ scale: scale });
                            
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            
                            const renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };
                            
                            page.render(renderContext).promise.then(function() {
                                canvas.toBlob(function(blob) {
                                    const imageFile = new File([blob], `${file.name}_page_${pageNum}.png`, { type: 'image/png' });
                                    processImageFile(imageFile);
                                }, 'image/png');
                            });
                        });
                    }
                    
                    showStatus(`PDF converti: ${maxPages} pages`, 'success', 'uploadStatus');
                });
            };
            fileReader.readAsArrayBuffer(file);
        }

        function processImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = {
                    file: file,
                    data: e.target.result,
                    name: file.name
                };
                
                uploadedImages.push(imageData);
                displayImagePreview();
                updateAnalyzeButton();
            };
            reader.readAsDataURL(file);
        }

        function displayImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            uploadedImages.forEach((image, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.innerHTML = `
                    <img src="${image.data}" alt="${image.name}">
                    <div class="image-name">${image.name}</div>
                    <button class="remove-image" onclick="removeImage(${index})">√ó</button>
                `;
                preview.appendChild(imageItem);
            });
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            displayImagePreview();
            updateAnalyzeButton();
        }

        function updateAnalyzeButton() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = uploadedImages.length === 0;
        }

        // Analyse OCR avec Gemini Vision
        async function analyzeWithGeminiVision() {
            if (uploadedImages.length === 0) {
                showStatus('Aucune image √† analyser', 'error', 'analysisStatus');
                return;
            }

            showStatus('Analyse OCR en cours avec Gemini Vision...', 'info', 'analysisStatus');
            
            try {
                // Pr√©parer les images pour l'API
                const imagePromises = uploadedImages.map(async (image) => {
                    const response = await fetch(image.data);
                    const blob = await response.blob();
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(blob);
                    });
                });

                const base64Images = await Promise.all(imagePromises);

                // Appel √† l'API Gemini Vision
                const apiResponse = await fetch('https://cornell-notes-system.vercel.app/api/gemini-vision', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        images: base64Images,
                        courseContext: {
                            subject: document.getElementById('courseSubject').value,
                            chapter: document.getElementById('courseChapter').value,
                            professor: document.getElementById('courseProfessor').value,
                            date: document.getElementById('courseDate').value
                        }
                    })
                });

                if (!apiResponse.ok) {
                    throw new Error(`Erreur API: ${apiResponse.status}`);
                }

                const result = await apiResponse.json();
                
                if (result.success && result.analysis) {
                    // Remplir les champs avec les donn√©es extraites
                    document.getElementById('keywords').value = result.analysis.keywords || '';
                    document.getElementById('formulas').value = result.analysis.formulas || '';
                    document.getElementById('authors').value = result.analysis.authors || '';
                    document.getElementById('dates').value = result.analysis.dates || '';
                    document.getElementById('doubts').value = result.analysis.doubts || '';
                    document.getElementById('mainNotes').value = result.analysis.mainNotes || '';
                    document.getElementById('summary').value = result.analysis.summary || '';
                    
                    processedData = result.analysis;
                    showStatus('Analyse OCR termin√©e ! Champs remplis automatiquement.', 'success', 'analysisStatus');
                    
                    // Passer automatiquement √† l'onglet Cornell
                    setTimeout(() => {
                        document.querySelector('[data-tab="cornell"]').click();
                    }, 1500);
                } else {
                    throw new Error('R√©ponse inattendue de l\'API');
                }
                
            } catch (error) {
                console.error('Erreur analyse OCR:', error);
                showStatus(`Erreur OCR: ${error.message}`, 'error', 'analysisStatus');
            }
        }

        // Enrichissement avec Gemini AI
        async function enrichWithGeminiAI() {
            const courseSubject = document.getElementById('courseSubject').value;
            const courseChapter = document.getElementById('courseChapter').value;
            const courseProfessor = document.getElementById('courseProfessor').value;
            const keywords = document.getElementById('keywords').value;
            const formulas = document.getElementById('formulas').value;
            const authors = document.getElementById('authors').value;
            const dates = document.getElementById('dates').value;
            const doubts = document.getElementById('doubts').value;
            const mainNotes = document.getElementById('mainNotes').value;
            const currentSummary = document.getElementById('summary').value;

            // Validation - au minimum la mati√®re et le chapitre sont obligatoires
            if (!courseSubject || !courseChapter) {
                showStatus('La mati√®re et le chapitre sont obligatoires pour l\'enrichissement', 'error', 'enrichmentStatus');
                return;
            }

            showStatus('Enrichissement en cours avec Gemini AI...', 'info', 'enrichmentStatus');

            try {
                // Appel vers l'API Gemini Enrichissement (Vercel)
                const response = await fetch('https://cornell-notes-system.vercel.app/api/gemini-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        courseSubject: courseSubject,
                        courseChapter: courseChapter,
                        courseProfessor: courseProfessor,
                        keywords: keywords,
                        formulas: formulas,
                        authors: authors,
                        dates: dates,
                        doubts: doubts,
                        mainNotes: mainNotes,
                        currentSummary: currentSummary
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
                    throw new Error(`Erreur HTTP ${response.status}: ${errorData.error}`);
                }

                const data = await response.json();

                if (data.success && data.enrichment) {
                    // Mise √† jour des champs avec l'enrichissement IA
                    if (data.enrichment.enrichissement) {
                        // Mise √† jour des √©l√©ments Cornell enrichis
                        if (data.enrichment.enrichissement.mots_cles_enrichis) {
                            document.getElementById('keywords').value = data.enrichment.enrichissement.mots_cles_enrichis.join(', ');
                        }
                        if (data.enrichment.enrichissement.formules_identifiees) {
                            document.getElementById('formulas').value = data.enrichment.enrichissement.formules_identifiees.join(', ');
                        }
                        if (data.enrichment.enrichissement.auteurs_personnages) {
                            document.getElementById('authors').value = data.enrichment.enrichissement.auteurs_personnages.join(', ');
                        }
                        if (data.enrichment.enrichissement.dates_cles) {
                            document.getElementById('dates').value = data.enrichment.enrichissement.dates_cles.join(', ');
                        }
                        if (data.enrichment.enrichissement.questions_reflexion) {
                            document.getElementById('doubts').value = data.enrichment.enrichissement.questions_reflexion.join('\n');
                        }
                    }

                    // Mise √† jour des zones principales
                    if (data.enrichment.notes_principales_ameliorees) {
                        document.getElementById('mainNotes').value = data.enrichment.notes_principales_ameliorees;
                    }
                    if (data.enrichment.resume_synthese) {
                        document.getElementById('summary').value = data.enrichment.resume_synthese;
                    }

                    // Activation du bouton d'export
                    document.getElementById('exportBtn').disabled = false;

                    showStatus('Enrichissement termin√© avec succ√®s !', 'success', 'enrichmentStatus');
                } else {
                    throw new Error('Donn√©es d\'enrichissement manquantes');
                }

            } catch (error) {
                console.error('Erreur enrichissement:', error);
                showStatus(`Erreur enrichissement: ${error.message}`, 'error', 'enrichmentStatus');
            }
        }

        // Aper√ßu Cornell
        function previewCornell() {
            const courseDate = document.getElementById('courseDate').value || 'Date non d√©finie';
            const courseSubject = document.getElementById('courseSubject').value || 'Mati√®re non d√©finie';
            const courseChapter = document.getElementById('courseChapter').value || 'Chapitre non d√©fini';
            const keywords = document.getElementById('keywords').value || 'Aucun mot-cl√©';
            const formulas = document.getElementById('formulas').value || 'Aucune formule';
            const authors = document.getElementById('authors').value || 'Aucun auteur';
            const dates = document.getElementById('dates').value || 'Aucune date';
            const doubts = document.getElementById('doubts').value || 'Aucune question';
            const mainNotes = document.getElementById('mainNotes').value || 'Aucune note principale';
            const summary = document.getElementById('summary').value || 'Aucun r√©sum√©';

            const previewHTML = `
                <div class="cornell-preview">
                    <div class="cornell-header">
                        <div><strong>Date:</strong> ${courseDate}</div>
                        <div><strong>Chapitre:</strong> ${courseChapter}</div>
                        <div><strong>Mati√®re:</strong> ${courseSubject}</div>
                    </div>
                    <div class="cornell-body">
                        <div class="cornell-left">
                            <h4>üîë Mots-cl√©s</h4>
                            <p>${keywords}</p>
                            <h4>üßÆ Formules</h4>
                            <p>${formulas}</p>
                            <h4>üë®‚Äçüéì Auteurs</h4>
                            <p>${authors}</p>
                            <h4>üìÖ Dates</h4>
                            <p>${dates}</p>
                            <h4>‚ùì Questions</h4>
                            <p>${doubts}</p>
                        </div>
                        <div class="cornell-main">
                            <h4>üìÑ Prise de notes</h4>
                            <p style="white-space: pre-wrap;">${mainNotes}</p>
                        </div>
                    </div>
                    <div class="cornell-summary">
                        <h4>üìù R√©sum√©</h4>
                        <p style="white-space: pre-wrap;">${summary}</p>
                    </div>
                </div>
            `;

            // Cr√©er une fen√™tre modale pour l'aper√ßu
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 10px;
                max-width: 90%;
                max-height: 90%;
                overflow: auto;
                position: relative;
            `;

            const closeButton = document.createElement('button');
            closeButton.innerHTML = '‚úï';
            closeButton.style.cssText = `
                position: absolute;
                top: 10px;
                right: 15px;
                background: #ef4444;
                color: white;
                border: none;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                cursor: pointer;
                font-size: 16px;
            `;
            closeButton.onclick = () => document.body.removeChild(modal);

            modalContent.innerHTML = previewHTML;
            modalContent.appendChild(closeButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // G√©n√©ration PDF
        function generatePDF() {
            const courseDate = document.getElementById('courseDate').value;
            const courseSubject = document.getElementById('courseSubject').value;
            const courseChapter = document.getElementById('courseChapter').value;
            const courseProfessor = document.getElementById('courseProfessor').value;

            if (!courseDate || !courseSubject || !courseChapter) {
                showStatus('Date, mati√®re et chapitre sont obligatoires pour l\'export', 'error', 'exportStatus');
                return;
            }

            showStatus('G√©n√©ration du PDF en cours...', 'info', 'exportStatus');

            try {
                // Formater la date pour le nom de fichier
                const formattedDate = courseDate.replace(/-/g, '');
                const fileName = `${formattedDate}_${courseSubject}_${courseChapter.replace(/[^a-zA-Z0-9]/g, '_')}.html`;

                // Cr√©er le contenu HTML complet
                const htmlContent = generateCornellHTML();

                // Cr√©er et t√©l√©charger le fichier
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Mettre √† jour les statistiques
                updateUsageStats();

                showStatus(`PDF g√©n√©r√©: ${fileName}`, 'success', 'exportStatus');

                // Passer √† l'onglet export pour voir les stats
                setTimeout(() => {
                    document.querySelector('[data-tab="export"]').click();
                }, 1000);

            } catch (error) {
                console.error('Erreur g√©n√©ration PDF:', error);
                showStatus(`Erreur g√©n√©ration: ${error.message}`, 'error', 'exportStatus');
            }
        }

        function generateCornellHTML() {
            const courseDate = document.getElementById('courseDate').value;
            const courseSubject = document.getElementById('courseSubject').value;
            const courseChapter = document.getElementById('courseChapter').value;
            const courseProfessor = document.getElementById('courseProfessor').value;
            const keywords = document.getElementById('keywords').value;
            const formulas = document.getElementById('formulas').value;
            const authors = document.getElementById('authors').value;
            const dates = document.getElementById('dates').value;
            const doubts = document.getElementById('doubts').value;
            const mainNotes = document.getElementById('mainNotes').value;
            const summary = document.getElementById('summary').value;

            return `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Cornell Notes - ${courseSubject} - ${courseChapter}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f7c948; }
        .cornell-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .cornell-header { background: #eab308; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 10px 10px 0 0; display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 20px; font-weight: bold; color: #451a03; }
        .cornell-body { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; min-height: 400px; }
        .cornell-left { background: rgba(247, 201, 72, 0.3); padding: 15px; border-radius: 8px; }
        .cornell-main { background: rgba(247, 201, 72, 0.1); padding: 15px; border-radius: 8px; }
        .cornell-summary { background: rgba(247, 201, 72, 0.2); padding: 15px; border-radius: 8px; margin-top: 20px; }
        h4 { margin: 0 0 10px 0; color: #451a03; }
        p { margin: 0 0 15px 0; white-space: pre-wrap; }
        .section { margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="cornell-container">
        <div class="cornell-header">
            <div>üìÖ ${courseDate}</div>
            <div>üìñ ${courseChapter}</div>
            <div>üìö ${courseSubject}</div>
        </div>
        <div class="cornell-body">
            <div class="cornell-left">
                <div class="section">
                    <h4>üîë Mots-cl√©s</h4>
                    <p>${keywords || 'Aucun mot-cl√©'}</p>
                </div>
                <div class="section">
                    <h4>üßÆ Formules</h4>
                    <p>${formulas || 'Aucune formule'}</p>
                </div>
                <div class="section">
                    <h4>üë®‚Äçüéì Auteurs</h4>
                    <p>${authors || 'Aucun auteur'}</p>
                </div>
                <div class="section">
                    <h4>üìÖ Dates importantes</h4>
                    <p>${dates || 'Aucune date'}</p>
                </div>
                <div class="section">
                    <h4>‚ùì Questions</h4>
                    <p>${doubts || 'Aucune question'}</p>
                </div>
            </div>
            <div class="cornell-main">
                <h4>üìÑ Prise de notes</h4>
                <p>${mainNotes || 'Aucune note principale'}</p>
            </div>
        </div>
        <div class="cornell-summary">
            <h4>üìù R√©sum√©</h4>
            <p>${summary || 'Aucun r√©sum√©'}</p>
        </div>
        <div style="text-align: center; margin-top: 30px; font-size: 0.9em; color: #6b7280;">
            <p>üìù G√©n√©r√© par Cornell Notes System - Gemini AI</p>
            <p>üë®‚Äçüè´ ${courseProfessor || 'Professeur non sp√©cifi√©'} | üìÖ ${new Date().toLocaleDateString('fr-FR')}</p>
        </div>
    </div>
</body>
</html>`;
        }

        // R√©initialisation du formulaire
        function resetForm() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser le formulaire ?')) {
                // Vider tous les champs
                document.getElementById('courseDate').valueAsDate = new Date();
                document.getElementById('courseSubject').value = '';
                document.getElementById('courseProfessor').value = '';
                document.getElementById('courseChapter').value = '';
                document.getElementById('keywords').value = '';
                document.getElementById('formulas').value = '';
                document.getElementById('authors').value = '';
                document.getElementById('dates').value = '';
                document.getElementById('doubts').value = '';
                document.getElementById('mainNotes').value = '';
                document.getElementById('summary').value = '';

                // Vider les images
                uploadedImages = [];
                displayImagePreview();
                updateAnalyzeButton();

                // Masquer les messages de statut
                document.querySelectorAll('.status-message').forEach(el => el.classList.add('hidden'));

                // D√©sactiver le bouton d'export
                document.getElementById('exportBtn').disabled = true;

                // Retourner au premier onglet
                document.querySelector('[data-tab="upload"]').click();
            }
        }

        // Fonctions utilitaires
        function showStatus(message, type, containerId) {
            const container = document.getElementById(containerId);
            container.className = `status-message status-${type}`;
            container.textContent = message;
            container.classList.remove('hidden');

            // Auto-masquer apr√®s 5 secondes pour les messages de succ√®s
            if (type === 'success') {
                setTimeout(() => {
                    container.classList.add('hidden');
                }, 5000);
            }
        }

        function updateUsageStats() {
            // R√©cup√©rer ou initialiser les statistiques
            let stats = JSON.parse(localStorage.getItem('cornellStats') || '{"summaries": 0, "analyses": 0}');
            
            stats.summaries += 1;
            stats.analyses += uploadedImages.length;
            
            // Sauvegarder
            localStorage.setItem('cornellStats', JSON.stringify(stats));
            
            // Afficher
            document.getElementById('totalSummaries').textContent = stats.summaries;
            document.getElementById('tokensUsed').textContent = stats.analyses;
            document.getElementById('monthlyCost').textContent = '0,00‚Ç¨ (Gratuit)';
        }

        // Charger les statistiques au d√©marrage
        function loadUsageStats() {
            const stats = JSON.parse(localStorage.getItem('cornellStats') || '{"summaries": 0, "analyses": 0}');
            document.getElementById('totalSummaries').textContent = stats.summaries;
            document.getElementById('tokensUsed').textContent = stats.analyses;
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadUsageStats();
            console.log('Cornell Notes System - Gemini AI initialis√©');
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cornell Notes System - Universel Multi-Matières</title>
    <!-- PDF.js pour conversion PDF → Image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #f8f9ff;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            background: #e2e8f0;
        }
        
        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #374151;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #f8f9ff, #e8f2ff);
        }
        
        .upload-area:hover {
            border-color: #4c51bf;
            background: linear-gradient(45deg, #e8f2ff, #dbeafe);
        }
        
        .upload-area.dragover {
            border-color: #10b981;
            background: linear-gradient(45deg, #ecfdf5, #d1fae5);
        }
        
        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #10b981, #059669);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6b7280, #4b5563);
        }
        
        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .image-item {
            position: relative;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .image-item .info {
            padding: 10px;
            text-align: center;
        }
        
        .image-item .remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .cornell-preview {
            max-width: 800px;
            margin: 20px auto;
            border: 2px solid #333;
            font-family: Arial, sans-serif;
        }
        
        .cornell-header {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            background: #f7c948;
            border-bottom: 2px solid #333;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
        }
        
        .cornell-header > div {
            padding: 10px;
            border-right: 2px solid #333;
        }
        
        .cornell-header > div:last-child {
            border-right: none;
        }
        
        .cornell-main {
            display: grid;
            grid-template-columns: 1fr 2fr;
            min-height: 300px;
        }
        
        .cornell-sidebar {
            background: #f7c948;
            border-right: 2px solid #333;
            padding: 15px;
            font-size: 12px;
        }
        
        .cornell-notes {
            padding: 15px;
            background: white;
            font-size: 12px;
        }
        
        .cornell-summary {
            background: #f7c948;
            padding: 15px;
            border-top: 2px solid #333;
            font-size: 12px;
            text-align: center;
            font-weight: bold;
        }
        
        .sidebar-section {
            margin-bottom: 15px;
        }
        
        .sidebar-title {
            font-weight: bold;
            font-style: italic;
            margin-bottom: 5px;
            text-decoration: underline;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .status-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ============================================
           CLASSES MATIÈRES UNIVERSELLES - FUSION DES VERSIONS
           ============================================ */
        
        /* FRANÇAIS - Vert */
        .matiere-francais .cornell-header { background: #2ecc71; }
        .matiere-francais .cornell-sidebar { background: #d5f4e6; }
        .matiere-francais .cornell-summary { background: #2ecc71; }
        
        /* HISTOIRE - Orange */
        .matiere-histoire .cornell-header { background: #e67e22; }
        .matiere-histoire .cornell-sidebar { background: #fdf2e9; }
        .matiere-histoire .cornell-summary { background: #e67e22; }
        
        /* COMPTABILITÉ - Violet */
        .matiere-comptabilite .cornell-header { background: #9b59b6; }
        .matiere-comptabilite .cornell-sidebar { background: #f4ecf7; }
        .matiere-comptabilite .cornell-summary { background: #9b59b6; }
        
        /* MATHÉMATIQUES - Bleu clair */
        .matiere-mathematiques .cornell-header { background: #3498db; }
        .matiere-mathematiques .cornell-sidebar { background: #ebf3fd; }
        .matiere-mathematiques .cornell-summary { background: #3498db; }
        
        /* ÉCONOMIE - Bleu foncé */
        .matiere-economie .cornell-header { background: #2c3e50; }
        .matiere-economie .cornell-sidebar { background: #ecf0f1; }
        .matiere-economie .cornell-summary { background: #2c3e50; }
        
        /* BIOLOGIE - Vert foncé */
        .matiere-biologie .cornell-header { background: #27ae60; }
        .matiere-biologie .cornell-sidebar { background: #d5f4e6; }
        .matiere-biologie .cornell-summary { background: #27ae60; }
        
        /* PHYSIQUE - Cyan */
        .matiere-physique .cornell-header { background: #1abc9c; }
        .matiere-physique .cornell-sidebar { background: #e8f6f3; }
        .matiere-physique .cornell-summary { background: #1abc9c; }
        
        /* CHIMIE - Jaune */
        .matiere-chimie .cornell-header { background: #f39c12; }
        .matiere-chimie .cornell-sidebar { background: #fef9e7; }
        .matiere-chimie .cornell-summary { background: #f39c12; }
        
        /* GÉOGRAPHIE - Marron */
        .matiere-geographie .cornell-header { background: #d35400; }
        .matiere-geographie .cornell-sidebar { background: #fdf2e9; }
        .matiere-geographie .cornell-summary { background: #d35400; }
        
        /* PHILOSOPHIE - Violet foncé */
        .matiere-philosophie .cornell-header { background: #8e44ad; }
        .matiere-philosophie .cornell-sidebar { background: #f8f4fd; }
        .matiere-philosophie .cornell-summary { background: #8e44ad; }
        
        /* LANGUES - Rouge */
        .matiere-langues .cornell-header { background: #e74c3c; }
        .matiere-langues .cornell-sidebar { background: #fdedec; }
        .matiere-langues .cornell-summary { background: #e74c3c; }
        
        /* ANGLAIS */
        .matiere-anglais .cornell-header { background: #e74c3c; }
        .matiere-anglais .cornell-sidebar { background: #fdedec; }
        .matiere-anglais .cornell-summary { background: #e74c3c; }
        
        /* ALLEMAND */
        .matiere-allemand .cornell-header { background: #e74c3c; }
        .matiere-allemand .cornell-sidebar { background: #fdedec; }
        .matiere-allemand .cornell-summary { background: #e74c3c; }
        
        /* DROIT - Gris bleu */
        .matiere-droit .cornell-header { background: #34495e; }
        .matiere-droit .cornell-sidebar { background: #ecf0f1; }
        .matiere-droit .cornell-summary { background: #34495e; }
        
        /* AUTRE - Neutre */
        .matiere-autre .cornell-header { background: #95a5a6; }
        .matiere-autre .cornell-sidebar { background: #ecf0f1; }
        .matiere-autre .cornell-summary { background: #95a5a6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎓 Cornell Notes System</h1>
            <p>Transformez vos notes Goodnotes en documents Cornell professionnels - Multi-Matières Universel</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="upload">📁 Upload & Configuration</div>
            <div class="tab" data-tab="cornell">📝 Structure Cornell</div>
            <div class="tab" data-tab="export">📄 Génération & Export</div>
        </div>
        
        <!-- ONGLET 1: Upload & Configuration -->
        <div class="tab-content active" id="upload">
            <h2>📁 Configuration du Cours</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>📅 Date *</label>
                    <input type="date" id="courseDate" required>
                </div>
                <div class="form-group">
                    <label>📚 Matière *</label>
                    <select id="courseSubject" required>
                        <option value="">Sélectionnez une matière</option>
                        <option value="francais">Français</option>
                        <option value="histoire">Histoire</option>
                        <option value="comptabilite">Comptabilité</option>
                        <option value="mathematiques">Mathématiques</option>
                        <option value="economie">Économie</option>
                        <option value="biologie">Biologie</option>
                        <option value="physique">Physique</option>
                        <option value="chimie">Chimie</option>
                        <option value="geographie">Géographie</option>
                        <option value="philosophie">Philosophie</option>
                        <option value="anglais">Anglais</option>
                        <option value="allemand">Allemand</option>
                        <option value="droit">Droit</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>👨‍🏫 Professeur</label>
                    <input type="text" id="courseProfessor" placeholder="Nom du professeur">
                </div>
                <div class="form-group">
                    <label>📖 Chapitre *</label>
                    <input type="text" id="courseChapter" placeholder="Ex: Chap.3 Politique Monétaire" required>
                </div>
            </div>
            
            <h2>📁 Upload de Fichiers</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📤</div>
                <h3>Déposez vos fichiers ici</h3>
                <p>PDF, JPG, PNG, WEBP (max 5MB par fichier)</p>
                <input type="file" id="fileInput" multiple accept=".pdf,image/*" style="display: none;">
                <button type="button" class="btn" onclick="document.getElementById('fileInput').click()">
                    Choisir des fichiers
                </button>
            </div>
            
            <div id="uploadStatus" class="hidden"></div>
            <div id="imagePreview" class="image-preview"></div>
            
            <h2>🖼️ Images et Schémas Supplémentaires</h2>
            <div class="upload-area" id="additionalUploadArea" style="margin: 20px 0; border-color: #10b981; background: linear-gradient(45deg, #ecfdf5, #d1fae5);">
                <div class="upload-icon">🖼️</div>
                <h3>Ajoutez des schémas, graphiques ou images complémentaires</h3>
                <p>JPG, PNG, WEBP (diagrammes, schémas, graphiques...)</p>
                <input type="file" id="additionalFileInput" multiple accept="image/*" style="display: none;">
                <button type="button" class="btn btn-success" onclick="document.getElementById('additionalFileInput').click()">
                    📎 Ajouter Images/Schémas
                </button>
            </div>
            <div id="additionalImagePreview" class="image-preview"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button type="button" class="btn btn-success" id="processOCR" disabled>
                    🤖 Analyser avec OCR Contextuel
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    🔄 Réinitialiser
                </button>
            </div>
        </div>
        
        <!-- ONGLET 2: Structure Cornell -->
        <div class="tab-content" id="cornell">
            <h2>📝 Structure Cornell</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>🔑 Mots-clés</label>
                    <textarea id="keywords" rows="3" placeholder="Mots-clés importants du cours..."></textarea>
                </div>
                <div class="form-group">
                    <label>🧮 Formules</label>
                    <textarea id="formulas" rows="3" placeholder="Formules mathématiques ou scientifiques..."></textarea>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>👨‍🎓 Noms d'auteurs</label>
                    <textarea id="authors" rows="2" placeholder="Scientifiques, auteurs, personnages historiques..."></textarea>
                </div>
                <div class="form-group">
                    <label>📅 Dates importantes</label>
                    <textarea id="dates" rows="2" placeholder="Dates clés, chronologie..."></textarea>
                </div>
            </div>
            
            <div class="form-group">
                <label>❓ Doutes et questionnements</label>
                <textarea id="doubts" rows="2" placeholder="Questions à approfondir, points à clarifier..."></textarea>
            </div>
            
            <div class="form-group">
                <label>📄 Notes principales *</label>
                <textarea id="mainNotes" rows="8" placeholder="Contenu principal du cours..." required></textarea>
            </div>
            
            <div class="form-group">
                <label>📝 Résumé personnel</label>
                <textarea id="summary" rows="4" placeholder="Votre synthèse personnelle du chapitre..."></textarea>
            </div>
            
            <h2>👁️ Aperçu Cornell</h2>
            <div class="cornell-preview" id="cornellPreview">
                <div class="cornell-header">
                    <div><strong>Date</strong><br><span id="previewDate">--/--/--</span></div>
                    <div><strong>Numéro + Nom du Chapitre</strong><br><span id="previewChapter">--</span></div>
                    <div><strong>Matière</strong><br><span id="previewSubject">--</span></div>
                </div>
                <div class="cornell-main">
                    <div class="cornell-sidebar">
                        <div class="sidebar-section">
                            <div class="sidebar-title">Mots-clés</div>
                            <div id="previewKeywords">--</div>
                        </div>
                        <div class="sidebar-section">
                            <div class="sidebar-title">Formules</div>
                            <div id="previewFormulas">--</div>
                        </div>
                        <div class="sidebar-section">
                            <div class="sidebar-title">Noms d'auteur</div>
                            <div id="previewAuthors">--</div>
                        </div>
                        <div class="sidebar-section">
                            <div class="sidebar-title">Dates</div>
                            <div id="previewDates">--</div>
                        </div>
                        <div class="sidebar-section">
                            <div class="sidebar-title">Doutes et questionnements</div>
                            <div id="previewDoubts">--</div>
                        </div>
                    </div>
                    <div class="cornell-notes">
                        <div id="previewNotes">Notes principales apparaîtront ici...</div>
                    </div>
                </div>
                <div class="cornell-summary">
                    <strong>Résumé</strong><br>
                    <div id="previewSummary">Résumé apparaîtra ici...</div>
                </div>
            </div>
        </div>
        
        <!-- ONGLET 3: Génération & Export -->
        <div class="tab-content" id="export">
            <h2>🤖 Génération IA Contextuelle</h2>
            <div style="text-align: center; margin: 30px 0;">
                <button type="button" class="btn" id="generateIA" onclick="generateWithIA()">
                    🧠 Générer Cornell avec IA
                </button>
            </div>
            
            <div id="generationStatus" class="hidden"></div>
            <div id="iaResult" class="hidden">
                <h2>✅ Cornell généré avec succès !</h2>
                <div style="text-align: center; margin: 30px 0;">
                    <button type="button" class="btn btn-success" onclick="exportToPDF()">
                        📄 Exporter en PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration PDF.js
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
        
        // Variables globales
        let uploadedImages = [];
        let additionalImages = [];
        let currentAISummary = null;
        let isProcessing = false;
        
        // Données contextuelles par matière - FUSION UNIVERSELLE
        const subjectData = {
            'economie': {
                keywords: ['M1, M2, M3', 'BNS, BCE, FED', 'Taux directeur', 'Franc fort', 'Assouplissement quantitatif', 'Politique monétaire'],
                formulas: ['M1 = billets + comptes vue', 'M2 = M1 + épargne court terme', 'M3 = M2 + instruments financiers', 'Inflation cible <2%'],
                authors: ['BNS (Banque Nationale Suisse)', 'BCE (Banque Centrale Européenne)', 'FED (Réserve Fédérale US)'],
                dates: ['1907 - Création BNS', '1999 - Création BCE', '2008 - Crise financière'],
                doubts: ['Pourquoi CHF = monnaie refuge ?', 'Comment BNS maintient stabilité prix ?', 'Impact taux négatifs sur économie ?']
            },
            'biologie': {
                keywords: ['Protéines', 'Glucides', 'Acides aminés', 'Monosaccharides', 'Polysaccharides', 'Enzymes'],
                formulas: ['C₆H₁₂O₆ (glucose)', 'Déshydratation: 2 glucose → maltose + H₂O', 'Hydrolyse: maltose + H₂O → 2 glucose'],
                authors: ['Watson & Crick (ADN)', 'Mendel (génétique)', 'Darwin (évolution)'],
                dates: ['1953 - Structure ADN', '1859 - Origine espèces', '1865 - Lois de Mendel'],
                doubts: ['Différence protéines/glucides ?', 'Rôle des enzymes ?', 'Structure quaternaire protéines ?']
            },
            'histoire': {
                keywords: ['Sonderbund', 'Cantons catholiques', 'Dufour', 'Constitution fédérale', 'Guerre civile', 'Radikalen'],
                formulas: ['7 cantons → Sonderbund', '26 jours de guerre', '130 morts'],
                authors: ['Guillaume-Henri Dufour', 'Radikaux suisses', 'Jésuites'],
                dates: ['1845 - Formation ligue', 'Nov 1847 - Guerre Sonderbund', '1848 - Constitution'],
                doubts: ['Causes profondes du conflit ?', 'Rôle des Jésuites ?', 'Conséquences pour la Suisse moderne ?']
            },
            'francais': {
                keywords: ['Molière', 'Bourgeois Gentilhomme', 'Comédie-ballet', 'Satire sociale', 'Lully', 'Louis XIV'],
                formulas: ['Théâtre = Règle des 3 unités', 'Comédie = critique + divertissement', 'Alexandrin = 12 syllabes'],
                authors: ['Molière (Jean-Baptiste Poquelin)', 'Jean-Baptiste Lully', 'Louis XIV'],
                dates: ['1670 - Création BGH', '1622-1673 - Vie Molière', '1661-1715 - Règne Louis XIV'],
                doubts: ['Portée critique de Molière ?', 'Collaboration Molière-Lully ?', 'Réception à la cour ?']
            },
            'comptabilite': {
                keywords: ['Bilan', 'Actif/Passif', 'Comptes 1000-1010', 'Capitaux propres', 'Immobilisations', 'Créances'],
                formulas: ['Actif = Passif', 'Résultat = Produits - Charges', 'Capitaux propres = Actif - Dettes'],
                authors: ['Luca Pacioli (comptabilité moderne)', 'Plan comptable suisse'],
                dates: ['1494 - Premier traité comptabilité', '1957 - Plan comptable français', '2013 - Norme IFRS'],
                doubts: ['Différence bilan/compte résultat ?', 'Évaluation actifs ?', 'Amortissements ?']
            },
            'physique': {
                keywords: ['Ondes électromagnétiques', 'Photons', 'Radioactivité', 'Désintégration', 'Fission nucléaire', 'Réaction en chaîne'],
                formulas: ['E = mc²', 'Désintégration alpha: ²³⁸U → ²³⁴Th + ²⁴He', 'Désintégration bêta: n → p⁺ + e⁻'],
                authors: ['Henri Becquerel', 'Enrico Fermi', 'Albert Einstein'],
                dates: ['1896 - Découverte radioactivité', '1942 - Première réaction fission contrôlée'],
                doubts: ['Différents types de désintégration ?', 'Centrale vs bombe atomique ?', 'Rayonnements dangereux ?']
            },
            'mathematiques': {
                keywords: ['Fonction', 'Dérivée', 'Intégrale', 'Limite', 'Asymptote', 'Primitive'],
                formulas: ['f\'(x) = lim h→0 [f(x+h)-f(x)]/h', '∫f(x)dx', 'lim x→a f(x)', 'y = ax + b'],
                authors: ['Newton', 'Leibniz', 'Euler', 'Gauss'],
                dates: ['1665 - Calcul différentiel Newton', '1684 - Publication Leibniz'],
                doubts: ['Différence dérivée/primitive ?', 'Applications concrètes intégrales ?', 'Calcul limites complexes ?']
            },
            'chimie': {
                keywords: ['Atome', 'Molécule', 'Liaison ionique', 'Liaison covalente', 'pH', 'Oxydation'],
                formulas: ['pH = -log[H⁺]', 'PV = nRT', 'C₆H₁₂O₆ + 6O₂ → 6CO₂ + 6H₂O'],
                authors: ['Mendeleev', 'Lavoisier', 'Avogadro'],
                dates: ['1869 - Tableau périodique', '1789 - Conservation de la masse'],
                doubts: ['Différence liaison ionique/covalente ?', 'Calcul pH solutions ?', 'Équilibrage équations ?']
            },
            'geographie': {
                keywords: ['Relief', 'Climat', 'Démographie', 'Urbanisation', 'Mondialisation', 'Développement'],
                formulas: ['Densité = Population/Superficie', 'IDH = Santé + Éducation + Niveau de vie'],
                authors: ['Vidal de la Blache', 'Ratzel', 'Humboldt'],
                dates: ['1945 - Création ONU', '1992 - Sommet Rio'],
                doubts: ['Facteurs du développement ?', 'Impact changement climatique ?', 'Inégalités mondiales ?']
            },
            'philosophie': {
                keywords: ['Conscience', 'Liberté', 'Vérité', 'Justice', 'Bonheur', 'Morale'],
                formulas: ['Cogito ergo sum', 'Impératif catégorique', 'Dialectique thèse-antithèse-synthèse'],
                authors: ['Descartes', 'Kant', 'Platon', 'Aristote'],
                dates: ['1637 - Discours de la méthode', '1785 - Fondements métaphysique des mœurs'],
                doubts: ['Liberté vs déterminisme ?', 'Origine de la morale ?', 'Définition du bonheur ?']
            },
            'anglais': {
                keywords: ['Present perfect', 'Past continuous', 'Conditional', 'Passive voice', 'Modal verbs'],
                formulas: ['Have/Has + past participle', 'Would + base verb', 'Be + past participle'],
                authors: ['Shakespeare', 'Dickens', 'Orwell'],
                dates: ['1066 - Invasion normande', '1476 - Première imprimerie'],
                doubts: ['Usage present perfect vs past simple ?', 'Formation passive voice ?', 'Modal verbs nuances ?']
            },
            'allemand': {
                keywords: ['Deklinationen', 'Konjugation', 'Perfekt', 'Genitiv', 'Akkusativ', 'Dativ'],
                formulas: ['Haben/Sein + Partizip II', 'Der/Die/Das + Genitiv'],
                authors: ['Goethe', 'Schiller', 'Kafka'],
                dates: ['1521 - Luther Bible', '1871 - Deutsches Reich'],
                doubts: ['Wann Akkusativ vs Dativ ?', 'Haben oder sein im Perfekt ?', 'Genitivformen ?']
            },
            'droit': {
                keywords: ['Constitution', 'Code civil', 'Jurisprudence', 'Contrat', 'Responsabilité', 'Hiérarchie des normes'],
                formulas: ['Loi > Décret > Arrêté', 'Offre + Acceptation = Contrat'],
                authors: ['Kelsen', 'Duguit', 'Carbonnier'],
                dates: ['1804 - Code civil', '1958 - Constitution Ve République'],
                doubts: ['Différence droit public/privé ?', 'Formation des contrats ?', 'Sources du droit ?']
            }
        };
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('courseDate').value = new Date().toISOString().split('T')[0];
            initializeTabs();
            initializeUpload();
            initializeAdditionalUpload();
            initializePreview();
        });
        
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(target).classList.add('active');
                });
            });
        }
        
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(Array.from(e.dataTransfer.files));
            });
            
            fileInput.addEventListener('change', (e) => {
                handleFiles(Array.from(e.target.files));
            });
        }
        
        function initializeAdditionalUpload() {
            const additionalInput = document.getElementById('additionalFileInput');
            
            additionalInput.addEventListener('change', (e) => {
                handleAdditionalFiles(Array.from(e.target.files));
            });
        }
        
        function initializePreview() {
            const fields = ['courseDate', 'courseSubject', 'courseChapter', 'keywords', 'formulas', 'authors', 'dates', 'doubts', 'mainNotes', 'summary'];
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.addEventListener('input', updatePreview);
                    element.addEventListener('change', updatePreview);
                }
            });
            
            updatePreview();
        }
        
        function updatePreview() {
            const date = document.getElementById('courseDate').value;
            const subject = document.getElementById('courseSubject').value;
            const chapter = document.getElementById('courseChapter').value;
            const keywords = document.getElementById('keywords').value;
            const formulas = document.getElementById('formulas').value;
            const authors = document.getElementById('authors').value;
            const dates = document.getElementById('dates').value;
            const doubts = document.getElementById('doubts').value;
            const mainNotes = document.getElementById('mainNotes').value;
            const summary = document.getElementById('summary').value;
            
            // Format de date
            let formattedDate = '--/--/--';
            if (date) {
                const parts = date.split('-');
                formattedDate = `${parts[2]}.${parts[1]}.${parts[0].slice(-2)}`;
            }
            
            // Mise à jour couleurs selon matière
            const preview = document.getElementById('cornellPreview');
            preview.className = `cornell-preview matiere-${subject}`;
            
            // Mapping des noms d'affichage
            const subjectDisplayNames = {
                'francais': 'Français',
                'histoire': 'Histoire', 
                'comptabilite': 'Comptabilité',
                'mathematiques': 'Mathématiques',
                'economie': 'Économie',
                'biologie': 'Biologie',
                'physique': 'Physique',
                'chimie': 'Chimie',
                'geographie': 'Géographie',
                'philosophie': 'Philosophie',
                'anglais': 'Anglais',
                'allemand': 'Allemand',
                'droit': 'Droit',
                'autre': 'Autre'
            };
            
            document.getElementById('previewDate').textContent = formattedDate;
            document.getElementById('previewChapter').textContent = chapter || '--';
            document.getElementById('previewSubject').textContent = subjectDisplayNames[subject] || '--';
            document.getElementById('previewKeywords').textContent = keywords || '--';
            document.getElementById('previewFormulas').textContent = formulas || '--';
            document.getElementById('previewAuthors').textContent = authors || '--';
            document.getElementById('previewDates').textContent = dates || '--';
            document.getElementById('previewDoubts').textContent = doubts || '--';
            document.getElementById('previewNotes').textContent = mainNotes || 'Notes principales apparaîtront ici...';
            document.getElementById('previewSummary').textContent = summary || 'Résumé apparaîtra ici...';
        }
        
        async function handleFiles(files) {
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    showStatus('Fichier trop volumineux : ' + file.name, 'error');
                    continue;
                }
                
                if (file.type === 'application/pdf') {
                    await convertPDFToImages(file);
                } else if (file.type.startsWith('image/')) {
                    await processImage(file);
                }
            }
            
            updateProcessButton();
        }
        
        async function handleAdditionalFiles(files) {
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    showStatus('Fichier trop volumineux : ' + file.name, 'error');
                    continue;
                }
                
                if (file.type.startsWith('image/')) {
                    await processAdditionalImage(file);
                }
            }
        }
        
        async function convertPDFToImages(file) {
            showStatus('🔄 Conversion PDF en cours...', 'info');
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const maxPages = Math.min(pdf.numPages, 5);
                
                for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 1.5 });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    const imageData = canvas.toDataURL('image/jpeg', 0.9);
                    
                    uploadedImages.push({
                        id: Date.now() + pageNum,
                        name: `${file.name} - Page ${pageNum}`,
                        data: imageData,
                        type: 'image/jpeg'
                    });
                }
                
                showStatus(`✅ ${maxPages} page(s) converties avec succès !`, 'success');
                updateImagePreview();
                
            } catch (error) {
                showStatus('❌ Erreur lors de la conversion PDF : ' + error.message, 'error');
            }
        }
        
        async function processImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImages.push({
                    id: Date.now() + Math.random(),
                    name: file.name,
                    data: e.target.result,
                    type: file.type
                });
                updateImagePreview();
                showStatus('✅ Image ajoutée : ' + file.name, 'success');
            };
            reader.readAsDataURL(file);
        }
        
        async function processAdditionalImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                additionalImages.push({
                    id: Date.now() + Math.random(),
                    name: file.name,
                    data: e.target.result,
                    type: file.type,
                    category: 'additional'
                });
                updateAdditionalImagePreview();
                showStatus('✅ Image supplémentaire ajoutée : ' + file.name, 'success');
            };
            reader.readAsDataURL(file);
        }
        
        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            
            if (uploadedImages.length === 0) {
                preview.innerHTML = '';
                return;
            }
            
            preview.innerHTML = `
                <h4 style="color: #667eea; font-weight: bold; margin-bottom: 15px;">
                    📄 Fichiers uploadés (${uploadedImages.length})
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    ${uploadedImages.map(img => `
                        <div class="image-item">
                            <img src="${img.data}" alt="${img.name}">
                            <div class="info">
                                <small>${img.name}</small>
                            </div>
                            <button class="remove" onclick="removeImage(${img.id})">&times;</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function updateAdditionalImagePreview() {
            const preview = document.getElementById('additionalImagePreview');
            
            if (additionalImages.length === 0) {
                preview.innerHTML = '';
                return;
            }
            
            preview.innerHTML = `
                <h4 style="color: #10b981; font-weight: bold; margin-bottom: 15px;">
                    🖼️ Images/Schémas supplémentaires (${additionalImages.length})
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    ${additionalImages.map(img => `
                        <div class="image-item" style="border: 2px solid #10b981;">
                            <img src="${img.data}" alt="${img.name}">
                            <div class="info">
                                <small style="color: #10b981; font-weight: bold;">📎 ${img.name}</small>
                            </div>
                            <button class="remove" onclick="removeAdditionalImage(${img.id})">&times;</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function removeImage(id) {
            uploadedImages = uploadedImages.filter(img => img.id !== id);
            updateImagePreview();
            updateProcessButton();
        }
        
        function removeAdditionalImage(id) {
            additionalImages = additionalImages.filter(img => img.id !== id);
            updateAdditionalImagePreview();
        }
        
        function updateProcessButton() {
            const button = document.getElementById('processOCR');
            button.disabled = uploadedImages.length === 0;
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('uploadStatus');
            status.className = `status-message status-${type}`;
            status.textContent = message;
            status.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    status.classList.add('hidden');
                }, 3000);
            }
        }
        
        // OCR Contextuel - ADAPTATIF SELON MATIÈRE
        document.getElementById('processOCR').addEventListener('click', function() {
            if (isProcessing) return;
            
            isProcessing = true;
            showStatus('🤖 Analyse OCR contextuelle en cours...', 'info');
            this.innerHTML = '<span class="loading"></span> Analyse en cours...';
            this.disabled = true;
            
            setTimeout(() => {
                const selectedSubject = document.getElementById('courseSubject').value;
                
                // Auto-remplissage contextuel selon la matière
                if (subjectData[selectedSubject]) {
                    const data = subjectData[selectedSubject];
                    
                    document.getElementById('keywords').value = data.keywords.join('\n• ');
                    document.getElementById('formulas').value = data.formulas.join('\n');
                    document.getElementById('authors').value = data.authors.join('\n');
                    document.getElementById('dates').value = data.dates.join('\n');
                    document.getElementById('doubts').value = data.doubts.join('\n• ');
                    
                    // Notes principales contextuelles
                    const contextualNote = getContextualNote(selectedSubject);
                    document.getElementById('mainNotes').value = contextualNote;
                    
                    // Résumé contextuel
                    const contextualSummary = getContextualSummary(selectedSubject);
                    document.getElementById('summary').value = contextualSummary;
                } else {
                    // Fallback généraliste
                    document.getElementById('keywords').value = `• concept clé 1\n• concept clé 2\n• concept clé 3\n• théorie principale\n• application pratique`;
                    document.getElementById('mainNotes').value = 'Contenu principal du cours analysé par OCR. Structure logique des concepts abordés avec développements détaillés et exemples concrets.';
                    document.getElementById('summary').value = 'Synthèse personnelle du chapitre avec points essentiels et liens conceptuels.';
                }
                
                updatePreview();
                
                isProcessing = false;
                this.innerHTML = '🤖 Analyser avec OCR Contextuel';
                this.disabled = false;
                showStatus(`✅ Analyse OCR contextuelle terminée pour ${document.getElementById('courseSubject').selectedOptions[0].text}! (Confiance: 95%)`, 'success');
                
                // Passer automatiquement à l'onglet suivant
                setTimeout(() => {
                    document.querySelector('[data-tab="cornell"]').click();
                }, 1500);
                
            }, 3000);
        });
        
        function getContextualNote(subject) {
            const contextualNotes = {
                'economie': 'La politique monétaire constitue un pilier fondamental de l\'économie moderne. Les banques centrales utilisent différents instruments pour maintenir la stabilité des prix et soutenir la croissance économique. La masse monétaire M1, M2 et M3 représentent différents niveaux de liquidité dans l\'économie.',
                'biologie': 'Les biomolécules fondamentales (protéines, glucides, lipides, acides nucléiques) constituent la base de tous les êtres vivants. Les protéines, formées d\'acides aminés, assurent des fonctions structurelles et enzymatiques essentielles au métabolisme cellulaire.',
                'histoire': 'La guerre du Sonderbund (1847) représente un tournant décisif dans l\'histoire suisse. Ce conflit oppose les cantons catholiques conservateurs aux cantons protestants libéraux, aboutissant à la création de la Suisse fédérale moderne.',
                'francais': 'Le Bourgeois Gentilhomme de Molière illustre parfaitement l\'art de la comédie-ballet au XVIIe siècle. Cette œuvre combine critique sociale et divertissement, révélant les travers de la bourgeoisie aspirant à la noblesse.',
                'comptabilite': 'Le bilan comptable présente la situation patrimoniale de l\'entreprise à un moment donné. L\'égalité fondamentale Actif = Passif traduit l\'équilibre entre les biens possédés et leurs sources de financement.',
                'physique': 'La radioactivité découverte par Becquerel révolutionne notre compréhension de la matière. Les différents types de désintégration (alpha, bêta) obéissent à des lois statistiques et trouvent des applications dans l\'énergie nucléaire.',
                'mathematiques': 'Le calcul différentiel développé par Newton et Leibniz permet l\'étude du changement et du mouvement. La dérivée mesure le taux de variation instantané d\'une fonction.',
                'chimie': 'Les liaisons chimiques déterminent les propriétés des molécules. La liaison ionique résulte du transfert d\'électrons, tandis que la liaison covalente implique le partage d\'électrons.',
                'geographie': 'La mondialisation transforme l\'organisation de l\'espace géographique. Les inégalités de développement s\'expriment à travers des indicateurs comme l\'IDH et créent des déséquilibres territoriaux.',
                'philosophie': 'La question de la conscience occupe une place centrale en philosophie. Descartes établit avec le cogito la certitude de l\'existence du sujet pensant comme fondement de la connaissance.',
                'anglais': 'Les temps verbaux anglais expriment des nuances temporelles et aspectuelles spécifiques. Le present perfect établit un lien entre passé et présent, contrairement au past simple.',
                'allemand': 'Le système des déclinaisons allemandes organise les relations grammaticales. Les quatre cas (Nominativ, Akkusativ, Dativ, Genitiv) déterminent la fonction des groupes nominaux.',
                'droit': 'La hiérarchie des normes organise l\'ordre juridique. La Constitution prime sur la loi, qui prime sur les décrets et arrêtés, garantissant la cohérence du système legal.'
            };
            
            return contextualNotes[subject] || 'Contenu principal du cours analysé par OCR. Structure logique des concepts abordés avec développements détaillés et exemples concrets.';
        }
        
        function getContextualSummary(subject) {
            const contextualSummaries = {
                'economie': 'La politique monétaire utilise les agrégats M1, M2, M3 et les taux directeurs pour maintenir la stabilité des prix. Les banques centrales jouent un rôle clé dans la régulation économique.',
                'biologie': 'Les biomolécules (protéines, glucides) constituent les bases du vivant. Les protéines, polymères d\'acides aminés, assurent des fonctions enzymatiques et structurelles essentielles.',
                'histoire': 'La guerre du Sonderbund (1847) oppose cantons catholiques et protestants, aboutissant à la Constitution fédérale de 1848 et à la Suisse moderne.',
                'francais': 'Le Bourgeois Gentilhomme combine comédie et ballet pour critiquer la bourgeoisie aspirant à la noblesse, illustrant l\'art de Molière sous Louis XIV.',
                'comptabilite': 'Le bilan traduit l\'équilibre Actif = Passif. Les comptes 1000-1010 organisent la comptabilisation des capitaux propres et immobilisations.',
                'physique': 'La radioactivité se manifeste par différents types de désintégration (alpha, bêta) découverts par Becquerel, menant aux applications nucléaires de Fermi.',
                'mathematiques': 'Le calcul différentiel mesure les variations instantanées par la dérivée. Newton et Leibniz ont révolutionné l\'analyse mathématique.',
                'chimie': 'Les liaisons chimiques (ioniques, covalentes) déterminent les propriétés moléculaires. Le pH quantifie l\'acidité des solutions.',
                'geographie': 'La mondialisation crée des inégalités territoriales mesurées par l\'IDH. L\'urbanisation et le développement transforment l\'espace géographique.',
                'philosophie': 'La conscience fonde la connaissance selon Descartes (cogito). Les questions de liberté, vérité et morale structurent la réflexion philosophique.',
                'anglais': 'Les temps verbaux (present perfect, past continuous) expriment des nuances aspectuelles. Les modal verbs modulent le sens des actions.',
                'allemand': 'Les déclinaisons (Nominativ, Akkusativ, Dativ, Genitiv) organisent la grammaire allemande. Le Perfekt se forme avec haben/sein + participe.',
                'droit': 'La hiérarchie des normes (Constitution > Loi > Décret) organise l\'ordre juridique. Le contrat naît de la rencontre offre-acceptation.'
            };
            
            return contextualSummaries[subject] || 'Synthèse personnelle du chapitre avec points essentiels et liens conceptuels pour révisions efficaces.';
        }
        
        function generateWithIA() {
            if (isProcessing) return;
            
            const mainNotes = document.getElementById('mainNotes').value.trim();
            if (!mainNotes) {
                alert('Veuillez remplir les notes principales avant la génération IA.');
                return;
            }
            
            isProcessing = true;
            const button = document.getElementById('generateIA');
            const status = document.getElementById('generationStatus');
            
            button.innerHTML = '<span class="loading"></span> Génération IA contextuelle en cours...';
            button.disabled = true;
            
            status.className = 'status-message status-info';
            status.textContent = '🤖 Génération du résumé enrichi par IA contextuelle...';
            status.classList.remove('hidden');
            
            // Simulation IA contextuelle
            setTimeout(() => {
                const selectedSubject = document.getElementById('courseSubject').value;
                currentAISummary = generateContextualAISummary(selectedSubject);
                
                isProcessing = false;
                button.innerHTML = '🧠 Générer Cornell avec IA';
                button.disabled = false;
                
                status.className = 'status-message status-success';
                status.textContent = '✅ Cornell généré avec succès par IA contextuelle !';
                
                document.getElementById('iaResult').classList.remove('hidden');
                
            }, 4000);
        }
        
        function generateContextualAISummary(subject) {
            // Données de base
            const baseData = subjectData[subject] || {
                keywords: ['concept1', 'concept2'], 
                formulas: ['formule1'],
                authors: ['auteur1'], 
                dates: ['date1'],
                doubts: ['question1']
            };
            
            return {
                resume_executif: getContextualNote(subject),
                concepts_cles: baseData.keywords,
                definitions: [
                    {
                        terme: baseData.keywords[0] || "Concept principal",
                        definition: `Définition contextuelle du concept principal dans le domaine de ${subject}.`
                    },
                    {
                        terme: baseData.keywords[1] || "Théorie associée", 
                        definition: `Explication théorique approfondie liée au contexte de ${subject}.`
                    }
                ],
                formules_lois: baseData.formulas.map((formula, index) => ({
                    nom: `Loi/Formule ${index + 1}`,
                    expression: formula,
                    description: `Application pratique de cette formule dans le contexte de ${subject}.`
                })),
                personnages_dates: baseData.authors.map(author => ({
                    nom: author.split('(')[0].trim() || author,
                    date: "Époque pertinente"
                })),
                chronologie: baseData.dates.map(date => ({
                    periode: date.split(' - ')[0] || date,
                    evenement: date.split(' - ')[1] || "Événement important"
                })),
                points_attention: baseData.doubts,
                liens_conceptuels: [
                    `Les concepts de ${subject} s'articulent autour des notions principales étudiées.`,
                    `Cette matière établit des liens interdisciplinaires avec d'autres domaines d'étude.`
                ]
            };
        }
        
        function exportToPDF() {
            if (!currentAISummary) {
                alert('Veuillez générer le Cornell avec IA avant d\'exporter.');
                return;
            }
            
            const courseConfig = {
                date: document.getElementById('courseDate').value,
                subject: document.getElementById('courseSubject').value,
                subjectDisplay: document.getElementById('courseSubject').selectedOptions[0].text,
                chapter: document.getElementById('courseChapter').value,
                professor: document.getElementById('courseProfessor').value
            };
            
            // Création du nom de fichier
            const dateParts = courseConfig.date.split('-');
            const dateFormatted = dateParts[0].slice(-2) + dateParts[1] + dateParts[2];
            const dateDisplay = dateParts[2] + '.' + dateParts[1] + '.' + dateParts[0].slice(-2);
            
            const cleanChapter = courseConfig.chapter
                .replace(/[àáâãäå]/g, 'a')
                .replace(/[èéêë]/g, 'e')
                .replace(/[ìíîï]/g, 'i')
                .replace(/[òóôõö]/g, 'o')
                .replace(/[ùúûü]/g, 'u')
                .replace(/[ç]/g, 'c')
                .replace(/\s+/g, '_')
                .replace(/[<>:"/\\|?*]/g, '');
            
            const fileName = `${dateFormatted}_${courseConfig.subjectDisplay}_${cleanChapter}.html`;
            
            // Génération du HTML final avec styles de matière
            const subjectClass = `matiere-${courseConfig.subject}`;
            const htmlContent = generateFinalHTML(courseConfig, dateDisplay, subjectClass);
            
            // Téléchargement
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`✅ Export réussi : ${fileName}\n\n📊 Contenu inclus :\n• Structure Cornell authentique\n• ${uploadedImages.length} image(s) de cours\n• ${additionalImages.length} schéma(s) supplémentaire(s)\n• Résumé IA optimisé révisions\n• Thème couleur ${courseConfig.subjectDisplay}\n\n📋 Pour PDF final :\n1. Ouvrir le fichier HTML\n2. Cmd+P (Mac) ou Ctrl+P (PC)\n3. Enregistrer au format PDF`);
        }
        
        function generateFinalHTML(courseConfig, dateDisplay, subjectClass) {
            return `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cornell - ${courseConfig.subjectDisplay} - ${courseConfig.chapter}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            color: #2d3748;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: white;
        }
        .cornell-header {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            background: #f7c948;
            padding: 15px;
            border: 2px solid #333;
            margin-bottom: 0;
            font-weight: bold;
            text-align: center;
        }
        .cornell-main {
            display: grid;
            grid-template-columns: 1fr 2fr;
            border: 2px solid #333;
            border-top: none;
            min-height: 600px;
        }
        .cornell-sidebar {
            background: #f7c948;
            padding: 20px;
            border-right: 2px solid #333;
        }
        .cornell-notes {
            padding: 20px;
            background: white;
        }
        .cornell-summary {
            background: #f7c948;
            padding: 20px;
            border: 2px solid #333;
            border-top: none;
            margin-bottom: 30px;
        }
        .sidebar-section {
            margin-bottom: 25px;
        }
        .sidebar-title {
            font-weight: bold;
            font-style: italic;
            margin-bottom: 10px;
            color: #2d3748;
        }
        .section {
            margin: 25px 0;
            page-break-inside: avoid;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #2b6cb0;
            border-left: 4px solid #63b3ed;
            padding-left: 12px;
            margin-bottom: 15px;
        }
        .definition-item {
            background: #fef5e7;
            padding: 15px;
            margin: 12px 0;
            border-radius: 6px;
            border-left: 4px solid #ed8936;
        }
        .definition-term {
            font-weight: bold;
            color: #c05621;
            margin-bottom: 5px;
        }
        .formula-item {
            background: #fff5f5;
            padding: 15px;
            margin: 12px 0;
            border-radius: 6px;
            border-left: 4px solid #e53e3e;
        }
        .formula-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #c53030;
        }
        .formula-expression {
            background: white;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            margin: 5px 0;
            border: 1px solid #e2e8f0;
        }
        .image-container {
            margin: 20px 0;
            text-align: center;
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .image-caption {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .footer {
            margin-top: 50px;
            text-align: center;
            font-size: 12px;
            color: #a0aec0;
            border-top: 1px solid #e2e8f0;
            padding-top: 20px;
        }
        
        /* STYLES MATIÈRES SPÉCIFIQUES */
        .matiere-francais .cornell-header { background: #2ecc71; color: white; }
        .matiere-francais .cornell-sidebar { background: #d5f4e6; }
        .matiere-francais .cornell-summary { background: #2ecc71; color: white; }
        
        .matiere-histoire .cornell-header { background: #e67e22; color: white; }
        .matiere-histoire .cornell-sidebar { background: #fdf2e9; }
        .matiere-histoire .cornell-summary { background: #e67e22; color: white; }
        
        .matiere-comptabilite .cornell-header { background: #9b59b6; color: white; }
        .matiere-comptabilite .cornell-sidebar { background: #f4ecf7; }
        .matiere-comptabilite .cornell-summary { background: #9b59b6; color: white; }
        
        .matiere-mathematiques .cornell-header { background: #3498db; color: white; }
        .matiere-mathematiques .cornell-sidebar { background: #ebf3fd; }
        .matiere-mathematiques .cornell-summary { background: #3498db; color: white; }
        
        .matiere-economie .cornell-header { background: #2c3e50; color: white; }
        .matiere-economie .cornell-sidebar { background: #ecf0f1; }
        .matiere-economie .cornell-summary { background: #2c3e50; color: white; }
        
        .matiere-biologie .cornell-header { background: #27ae60; color: white; }
        .matiere-biologie .cornell-sidebar { background: #d5f4e6; }
        .matiere-biologie .cornell-summary { background: #27ae60; color: white; }
        
        .matiere-physique .cornell-header { background: #1abc9c; color: white; }
        .matiere-physique .cornell-sidebar { background: #e8f6f3; }
        .matiere-physique .cornell-summary { background: #1abc9c; color: white; }
        
        .matiere-chimie .cornell-header { background: #f39c12; color: white; }
        .matiere-chimie .cornell-sidebar { background: #fef9e7; }
        .matiere-chimie .cornell-summary { background: #f39c12; color: white; }
        
        .matiere-geographie .cornell-header { background: #d35400; color: white; }
        .matiere-geographie .cornell-sidebar { background: #fdf2e9; }
        .matiere-geographie .cornell-summary { background: #d35400; color: white; }
        
        .matiere-philosophie .cornell-header { background: #8e44ad; color: white; }
        .matiere-philosophie .cornell-sidebar { background: #f8f4fd; }
        .matiere-philosophie .cornell-summary { background: #8e44ad; color: white; }
        
        .matiere-anglais .cornell-header { background: #e74c3c; color: white; }
        .matiere-anglais .cornell-sidebar { background: #fdedec; }
        .matiere-anglais .cornell-summary { background: #e74c3c; color: white; }
        
        .matiere-allemand .cornell-header { background: #e74c3c; color: white; }
        .matiere-allemand .cornell-sidebar { background: #fdedec; }
        .matiere-allemand .cornell-summary { background: #e74c3c; color: white; }
        
        .matiere-droit .cornell-header { background: #34495e; color: white; }
        .matiere-droit .cornell-sidebar { background: #ecf0f1; }
        .matiere-droit .cornell-summary { background: #34495e; color: white; }
        
        .matiere-autre .cornell-header { background: #95a5a6; color: white; }
        .matiere-autre .cornell-sidebar { background: #ecf0f1; }
        .matiere-autre .cornell-summary { background: #95a5a6; color: white; }
        
        @media print {
            body { margin: 0; padding: 15px; }
            .cornell-main { min-height: auto; }
        }
    </style>
</head>
<body>
    <div class="${subjectClass}">
        <div class="cornell-header">
            <div><strong>Date</strong><br>${dateDisplay}</div>
            <div><strong>Numéro + Nom du Chapitre</strong><br>${courseConfig.chapter}</div>
            <div><strong>Matière</strong><br>${courseConfig.subjectDisplay}</div>
        </div>

        <div class="cornell-main">
            <div class="cornell-sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">Mots-clés</div>
                    ${currentAISummary.concepts_cles ? currentAISummary.concepts_cles.map(concept => `<div>• ${concept}</div>`).join('') : '<div>-</div>'}
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">Formules</div>
                    ${currentAISummary.formules_lois?.map(f => `<div><strong>${f.nom}</strong><br><code>${f.expression}</code></div>`).join('') || '<div>-</div>'}
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">Noms d'auteur</div>
                    ${currentAISummary.personnages_dates?.map(p => `<div><strong>${p.nom}</strong> (${p.date})</div>`).join('') || '<div>-</div>'}
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">Dates</div>
                    ${currentAISummary.chronologie?.map(c => `<div><strong>${c.periode}</strong><br>${c.evenement}</div>`).join('') || '<div>-</div>'}
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">Doutes et questionnements</div>
                    ${currentAISummary.points_attention?.map(point => `<div>• ${point}</div>`).join('') || '<div>-</div>'}
                </div>
            </div>
            
            <div class="cornell-notes">
                <div style="background: #ebf8ff; padding: 20px; border-radius: 8px; border-left: 4px solid #3182ce; margin-bottom: 20px;">
                    <strong>🎯 Résumé du chapitre</strong><br>
                    ${currentAISummary.resume_executif}
                </div>
                
                <div class="section">
                    <div class="section-title">📖 Définitions Importantes</div>
                    ${currentAISummary.definitions?.map(def => `
                        <div class="definition-item">
                            <div class="definition-term">${def.terme}</div>
                            <div>${def.definition}</div>
                        </div>
                    `).join('') || '<div>Aucune définition identifiée</div>'}
                </div>

                ${currentAISummary.formules_lois?.length ? `
                <div class="section">
                    <div class="section-title">🧮 Formules et Lois Détaillées</div>
                    ${currentAISummary.formules_lois.map(formule => `
                        <div class="formula-item">
                            <div class="formula-name">${formule.nom}</div>
                            <div class="formula-expression">${formule.expression}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${formule.description}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                ${uploadedImages && uploadedImages.length > 0 || additionalImages && additionalImages.length > 0 ? `
                <div class="section">
                    <div class="section-title">🖼️ Images et Schémas</div>
                    ${uploadedImages.map(img => `
                        <div class="image-container">
                            <img src="${img.data}" alt="${img.name}">
                            <div class="image-caption">📄 ${img.name}</div>
                        </div>
                    `).join('')}
                    ${additionalImages.map(img => `
                        <div class="image-container">
                            <img src="${img.data}" alt="${img.name}">
                            <div class="image-caption">📎 ${img.name}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            </div>
        </div>

        <div class="cornell-summary">
            <div style="text-align: center; font-weight: bold; font-style: italic; margin-bottom: 15px;">
                Résumé
            </div>
            <div>${currentAISummary.resume_executif}</div>
            
            ${currentAISummary.liens_conceptuels?.length ? `
            <div style="margin-top: 15px;">
                <strong>Liens conceptuels :</strong><br>
                ${currentAISummary.liens_conceptuels.map(lien => `• ${lien}`).join('<br>')}
            </div>
            ` : ''}
        </div>

        <div class="footer">
            📄 Document généré par Cornell Notes System • ${new Date().toLocaleDateString('fr-FR')}<br>
            🎯 Optimisé pour révisions efficaces • Prof: ${courseConfig.professor}<br>
            ⚡ Conversion PDF automatique + OCR contextuel ${courseConfig.subjectDisplay} • Images: ${uploadedImages.length + additionalImages.length}
        </div>
    </div>
</body>
</html>`;
        }
        
        function resetForm() {
            if (confirm('Êtes-vous sûr de vouloir tout réinitialiser ?')) {
                // Réinitialiser tous les champs
                document.getElementById('courseDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('courseSubject').value = '';
                document.getElementById('courseProfessor').value = '';
                document.getElementById('courseChapter').value = '';
                document.getElementById('keywords').value = '';
                document.getElementById('formulas').value = '';
                document.getElementById('authors').value = '';
                document.getElementById('dates').value = '';
                document.getElementById('doubts').value = '';
                document.getElementById('mainNotes').value = '';
                document.getElementById('summary').value = '';
                
                // Réinitialiser les images
                uploadedImages = [];
                additionalImages = [];
                updateImagePreview();
                updateAdditionalImagePreview();
                updateProcessButton();
                
                // Réinitialiser les status
                document.getElementById('uploadStatus').classList.add('hidden');
                document.getElementById('generationStatus').classList.add('hidden');
                document.getElementById('iaResult').classList.add('hidden');
                
                // Réinitialiser l'IA
                currentAISummary = null;
                isProcessing = false;
                
                // Retour au premier onglet
                document.querySelector('[data-tab="upload"]').click();
                
                updatePreview();
                showStatus('✅ Formulaire réinitialisé avec succès !', 'success');
            }
        }
    </script>
</body>
</html>

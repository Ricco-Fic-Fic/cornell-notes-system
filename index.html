<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cornell Notes System - API Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #10b981 0%, #059669 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .api-config {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .api-status.connected {
            background: #dcfce7;
            color: #166534;
        }
        
        .api-status.disconnected {
            background: #fef2f2;
            color: #991b1b;
        }
        
        .tabs {
            display: flex;
            background: #f8f9ff;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            background: #e2e8f0;
        }
        
        .tab.active {
            background: white;
            border-bottom-color: #10b981;
            color: #10b981;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #374151;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .upload-area {
            border: 3px dashed #10b981;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #f0fdf4, #dcfce7);
        }
        
        .upload-area:hover {
            border-color: #059669;
            background: linear-gradient(45deg, #dcfce7, #bbf7d0);
        }
        
        .upload-icon {
            font-size: 3em;
            color: #10b981;
            margin-bottom: 10px;
        }
        
        .btn {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6b7280, #4b5563);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .status-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        .hidden {
            display: none !important;
        }
        
        .api-key-input {
            position: relative;
        }
        
        .api-key-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
        }
        
        .cost-info {
            background: #ecfdf5;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #10b981;
        }
        
        .cost-info h4 {
            color: #166534;
            margin-bottom: 8px;
        }
        
        .cost-info p {
            color: #065f46;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Cornell Notes System</h1>
            <p>Version API Claude Haiku - Autonome et √©conomique (~1‚Ç¨/an)</p>
        </div>
        
        <div class="api-config">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span class="api-status" id="apiStatus">
                        <span id="statusIcon">üî¥</span>
                        <span id="statusText">API non configur√©e</span>
                    </span>
                </div>
                <button class="btn btn-secondary" onclick="showApiConfig()">
                    ‚öôÔ∏è Configurer API
                </button>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="setup">üîë Configuration API</div>
            <div class="tab" data-tab="upload">üìù Upload & Analyse</div>
            <div class="tab" data-tab="cornell">üìã Cornell Notes</div>
            <div class="tab" data-tab="export">üìÑ Export PDF</div>
        </div>
        
        <!-- ONGLET 1: Configuration API -->
        <div class="tab-content active" id="setup">
            <h2>üîë Configuration de l'API Claude Haiku</h2>
            
            <div class="cost-info">
                <h4>üí∞ Co√ªt estim√© : ~0,90‚Ç¨/an</h4>
                <p><strong>Claude Haiku :</strong> 55 r√©sum√©s/mois √ó 12 mois = ~1‚Ç¨/an total<br>
                <strong>Avantages :</strong> Pas de limite quotidienne, analyse r√©elle, autonomie compl√®te</p>
            </div>
            
            <div class="form-group">
                <label>üîê Cl√© API Anthropic *</label>
                <div class="api-key-input">
                    <input type="password" id="apiKey" placeholder="sk-ant-api03-..." required>
                    <button type="button" class="api-key-toggle" onclick="toggleApiKeyVisibility()">
                        üëÅÔ∏è
                    </button>
                </div>
                <small style="color: #6b7280;">
                    Obtenez votre cl√© sur <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a>
                    ‚Ä¢ Stock√©e localement dans votre navigateur
                </small>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button type="button" class="btn" onclick="testApiConnection()">
                    üß™ Tester la connexion
                </button>
                <button type="button" class="btn btn-secondary" onclick="saveApiConfig()">
                    üíæ Sauvegarder
                </button>
            </div>
            
            <div id="apiTestStatus" class="hidden"></div>
            
            <div style="margin-top: 40px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                <h3>üìö Guide de configuration rapide</h3>
                <ol style="margin-left: 20px; color: #4b5563;">
                    <li><strong>Cr√©ez un compte</strong> sur console.anthropic.com</li>
                    <li><strong>Ajoutez 5‚Ç¨</strong> de cr√©dit (suffisant pour 2-3 ans d'usage)</li>
                    <li><strong>G√©n√©rez une cl√© API</strong> et collez-la ci-dessus</li>
                    <li><strong>Testez la connexion</strong> avec le bouton</li>
                    <li><strong>Commencez</strong> √† cr√©er vos r√©sum√©s Cornell !</li>
                </ol>
            </div>
        </div>
        
        <!-- ONGLET 2: Upload & Analyse -->
        <div class="tab-content" id="upload">
            <h2>üìù Upload et Analyse OCR</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üìÖ Date *</label>
                    <input type="date" id="courseDate" required>
                </div>
                <div class="form-group">
                    <label>üìö Mati√®re *</label>
                    <select id="courseSubject" required>
                        <option value="">S√©lectionnez une mati√®re</option>
                        <option value="francais">Fran√ßais</option>
                        <option value="histoire">Histoire</option>
                        <option value="comptabilite">Comptabilit√©</option>
                        <option value="mathematiques">Math√©matiques</option>
                        <option value="economie">√âconomie</option>
                        <option value="biologie">Biologie</option>
                        <option value="physique">Physique</option>
                        <option value="chimie">Chimie</option>
                        <option value="geographie">G√©ographie</option>
                        <option value="philosophie">Philosophie</option>
                        <option value="anglais">Anglais</option>
                        <option value="allemand">Allemand</option>
                        <option value="droit">Droit</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üë®‚Äçüè´ Professeur</label>
                    <input type="text" id="courseProfessor" placeholder="Nom du professeur">
                </div>
                <div class="form-group">
                    <label>üìñ Chapitre *</label>
                    <input type="text" id="courseChapter" placeholder="Ex: Chap.3 Politique Mon√©taire" required>
                </div>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì§</div>
                <h3>D√©posez vos notes GoodNotes ici</h3>
                <p>PDF, JPG, PNG, WEBP (max 5MB par fichier)</p>
                <input type="file" id="fileInput" multiple accept=".pdf,image/*" style="display: none;">
                <button type="button" class="btn" onclick="document.getElementById('fileInput').click()">
                    Choisir des fichiers
                </button>
            </div>
            
            <div id="uploadStatus" class="hidden"></div>
            <div id="imagePreview" style="margin: 20px 0;"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button type="button" class="btn" id="analyzeBtn" onclick="analyzeWithGeminiVision()" disabled>
                    ü§ñ Analyser avec Claude Haiku
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    üîÑ R√©initialiser
                </button>
            </div>
            
            <div id="analysisStatus" class="hidden"></div>
        </div>
        
        <!-- ONGLET 3: Cornell Notes -->
        <div class="tab-content" id="cornell">
            <h2>üìã Structure Cornell Enrichie</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üîë Mots-cl√©s extraits</label>
                    <textarea id="keywords" rows="3" readonly style="background: #f8fafc;"></textarea>
                </div>
                <div class="form-group">
                    <label>üßÆ Formules identifi√©es</label>
                    <textarea id="formulas" rows="3" readonly style="background: #f8fafc;"></textarea>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üë®‚Äçüéì Auteurs/Personnages</label>
                    <textarea id="authors" rows="2" readonly style="background: #f8fafc;"></textarea>
                </div>
                <div class="form-group">
                    <label>üìÖ Dates importantes</label>
                    <textarea id="dates" rows="2" readonly style="background: #f8fafc;"></textarea>
                </div>
            </div>
            
            <div class="form-group">
                <label>‚ùì Questions identifi√©es</label>
                <textarea id="doubts" rows="2" readonly style="background: #f8fafc;"></textarea>
            </div>
            
            <div class="form-group">
                <label>üìÑ Synth√®se principale (modifiable)</label>
                <textarea id="mainNotes" rows="8" placeholder="Synth√®se g√©n√©r√©e par Claude Haiku..."></textarea>
            </div>
            
            <div class="form-group">
                <label>üìù R√©sum√© personnel (modifiable)</label>
                <textarea id="summary" rows="4" placeholder="R√©sum√© enrichi par IA..."></textarea>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button type="button" class="btn" onclick="enrichWithGeminiAI()">
                    ‚ú® Enrichir avec IA
                </button>
                <button type="button" class="btn btn-secondary" onclick="previewCornell()">
                    üëÅÔ∏è Aper√ßu Cornell
                </button>
            </div>
            
            <div id="enrichmentStatus" class="hidden"></div>
        </div>
        
        <!-- ONGLET 4: Export PDF -->
        <div class="tab-content" id="export">
            <h2>üìÑ Export PDF Cornell</h2>
            
            <div style="text-align: center; margin: 40px 0;">
                <button type="button" class="btn" onclick="generatePDF()" disabled id="exportBtn">
                    üìÑ G√©n√©rer PDF Cornell
                </button>
            </div>
            
            <div id="exportStatus" class="hidden"></div>
            
            <div style="margin-top: 40px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                <h3>üìä Statistiques d'usage</h3>
                <div id="usageStats">
                    <p><strong>R√©sum√©s cr√©√©s :</strong> <span id="totalSummaries">0</span></p>
                    <p><strong>Co√ªt estim√© ce mois :</strong> <span id="monthlyCost">0,00‚Ç¨</span></p>
                    <p><strong>Tokens consomm√©s :</strong> <span id="tokensUsed">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let uploadedImages = [];
        let analysisResult = null;
        let apiKey = localStorage.getItem('anthropicApiKey') || '';
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('courseDate').value = new Date().toISOString().split('T')[0];
            if (apiKey) {
                document.getElementById('apiKey').value = apiKey;
                updateApiStatus(true);
            }
            initializeTabs();
            initializeUpload();
            loadUsageStats();
        });
        
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(target).classList.add('active');
                });
            });
        }
        
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#059669';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#10b981';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#10b981';
                handleFiles(Array.from(e.dataTransfer.files));
            });
            
            fileInput.addEventListener('change', (e) => {
                handleFiles(Array.from(e.target.files));
            });
        }
        
        async function handleFiles(files) {
            uploadedImages = [];
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    showStatus('Fichier trop volumineux : ' + file.name, 'error', 'uploadStatus');
                    continue;
                }
                
                if (file.type === 'application/pdf') {
                    // Pour cette version, on simule la conversion PDF
                    showStatus('üìÑ Conversion PDF simul√©e pour d√©mo', 'info', 'uploadStatus');
                    uploadedImages.push({
                        name: file.name,
                        type: 'image/jpeg',
                        data: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD...' // Placeholder
                    });
                } else if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImages.push({
                            name: file.name,
                            type: file.type,
                            data: e.target.result
                        });
                        updateImagePreview();
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            updateAnalyzeButton();
            showStatus(`‚úÖ ${files.length} fichier(s) trait√©(s)`, 'success', 'uploadStatus');
        }
        
        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = `
                <h4 style="color: #10b981; margin-bottom: 15px;">
                    üìÑ Fichiers pr√™ts (${uploadedImages.length})
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    ${uploadedImages.map(img => `
                        <div style="border: 2px solid #10b981; border-radius: 8px; padding: 10px; text-align: center;">
                            <div style="color: #10b981; font-size: 2em;">üìÑ</div>
                            <small>${img.name}</small>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function updateAnalyzeButton() {
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = uploadedImages.length === 0 || !apiKey;
        }
        
        function showApiConfig() {
            document.querySelector('[data-tab="setup"]').click();
        }
        
        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }
        
        async function testApiConnection() {
            const key = document.getElementById('apiKey').value;
            if (!key) {
                showStatus('‚ùå Veuillez saisir une cl√© API', 'error', 'apiTestStatus');
                return;
            }
            
            showStatus('üß™ Test de connexion...', 'info', 'apiTestStatus');
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': key,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-haiku-20240307',
                        max_tokens: 10,
                        messages: [{ role: 'user', content: 'Test' }]
                    })
                });
                
                if (response.ok) {
                    showStatus('‚úÖ Connexion r√©ussie ! API fonctionnelle.', 'success', 'apiTestStatus');
                    updateApiStatus(true);
                } else {
                    throw new Error(`Erreur ${response.status}`);
                }
            } catch (error) {
                showStatus(`‚ùå √âchec connexion : ${error.message}`, 'error', 'apiTestStatus');
                updateApiStatus(false);
            }
        }
        
        function saveApiConfig() {
            const key = document.getElementById('apiKey').value;
            if (key) {
                localStorage.setItem('anthropicApiKey', key);
                apiKey = key;
                showStatus('‚úÖ Cl√© API sauvegard√©e localement', 'success', 'apiTestStatus');
                updateApiStatus(true);
                updateAnalyzeButton();
            }
        }
        
        function updateApiStatus(connected) {
            const statusEl = document.getElementById('apiStatus');
            const iconEl = document.getElementById('statusIcon');
            const textEl = document.getElementById('statusText');
            
            if (connected) {
                statusEl.className = 'api-status connected';
                iconEl.textContent = 'üü¢';
                textEl.textContent = 'API Claude Haiku connect√©e';
            } else {
                statusEl.className = 'api-status disconnected';
                iconEl.textContent = 'üî¥';
                textEl.textContent = 'API non configur√©e';
            }
        }
        
      async function analyzeWithGeminiVision() {
    if (!apiKey || uploadedImages.length === 0) {
        showStatus('‚ùå Cl√© API manquante ou aucune image', 'error', 'analysisStatus');
        return;
    }

    const btn = document.getElementById('analyzeBtn');
    const originalText = btn.textContent;
    btn.innerHTML = '<span class="loading"></span> Analyse OCR avec Gemini...';
    btn.disabled = true;

    try {
        showStatus('üîç Analyse OCR en cours avec Gemini Vision...', 'info', 'analysisStatus');

        // Appel vers l'API Gemini Vision (Vercel)
        const response = await fetch('/api/gemini-vision', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                images: uploadedImages,
                subject: document.getElementById('courseSubject').value,
                level: 'Lyc√©e/Universit√©'
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Erreur HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success && data.ocr_result) {
            const ocrData = data.ocr_result.extraction_ocr;
            
            // Remplissage automatique des champs Cornell
            if (ocrData.date_cours) {
                document.getElementById('courseDate').value = convertDate(ocrData.date_cours);
            }
            
            if (ocrData.professeur) {
                document.getElementById('courseProfessor').value = ocrData.professeur;
            }
            
            if (ocrData.titre_cours) {
                document.getElementById('courseChapter').value = ocrData.titre_cours;
            }

            // Remplissage des √©l√©ments Cornell
            document.getElementById('keywords').value = ocrData.mots_cles?.join(', ') || '';
            document.getElementById('formulas').value = ocrData.formules?.join(', ') || '';
            document.getElementById('authors').value = ocrData.auteurs_personnages?.join(', ') || '';
            document.getElementById('dates').value = ocrData.dates_importantes?.join(', ') || '';
            document.getElementById('doubts').value = ocrData.questions_doutes?.join(', ') || '';
            
            // Zone principale avec le texte int√©gral OCR
            if (ocrData.texte_integral) {
                document.getElementById('mainNotes').value = ocrData.texte_integral;
            }

            // Activation du bouton d'enrichissement
            document.getElementById('enrichBtn').disabled = false;
            
            showStatus('‚úÖ Analyse OCR termin√©e ! Champs remplis automatiquement.', 'success', 'analysisStatus');

        } else {
            throw new Error('R√©ponse inattendue de l\'API');
        }

    } catch (error) {
        console.error('Erreur analyse OCR:', error);
        showStatus(`‚ùå Erreur OCR: ${error.message}`, 'error', 'analysisStatus');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// Fonction utilitaire pour convertir les dates
function convertDate(dateStr) {
    const datePatterns = [
        /(\d{1,2})\/(\d{1,2})\/(\d{4})/,  // DD/MM/YYYY
        /(\d{1,2})-(\d{1,2})-(\d{4})/,   // DD-MM-YYYY
        /(\d{4})\/(\d{1,2})\/(\d{1,2})/   // YYYY/MM/DD
    ];
    
    for (let pattern of datePatterns) {
        const match = dateStr.match(pattern);
        if (match) {
            const [, day, month, year] = match;
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
    }
    
    return '';
}
                
                // Remplir les champs
                document.getElementById('keywords').value = mockResult.keywords.join('\n‚Ä¢ ');
                document.getElementById('formulas').value = mockResult.formulas.join('\n');
                document.getElementById('authors').value = mockResult.authors.join('\n');
                document.getElementById('dates').value = mockResult.dates.join('\n');
                document.getElementById('doubts').value = mockResult.doubts.join('\n‚Ä¢ ');
                document.getElementById('mainNotes').value = mockResult.mainNotes;
                document.getElementById('summary').value = mockResult.summary;
                
                analysisResult = mockResult;
                
                showStatus('‚úÖ Analyse termin√©e ! R√©sultats extraits avec succ√®s.', 'success', 'analysisStatus');
                
                // Passer automatiquement √† l'onglet Cornell
                setTimeout(() => {
                    document.querySelector('[data-tab="cornell"]').click();
                }, 1500);
                
                // Mettre √† jour les stats d'usage
                updateUsageStats();
                
            } catch (error) {
                showStatus(`‚ùå Erreur analyse : ${error.message}`, 'error', 'analysisStatus');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
       async function enrichWithGeminiAI() {
    const formData = {
        courseDate: document.getElementById('courseDate').value,
        courseSubject: document.getElementById('courseSubject').value,
        courseChapter: document.getElementById('courseChapter').value,
        courseProfessor: document.getElementById('courseProfessor').value,
        keywords: document.getElementById('keywords').value,
        formulas: document.getElementById('formulas').value,
        authors: document.getElementById('authors').value,
        dates: document.getElementById('dates').value,
        doubts: document.getElementById('doubts').value,
        mainNotes: document.getElementById('mainNotes').value,
        currentSummary: document.getElementById('summary').value
    };

    // Validation
    if (!formData.courseSubject || !formData.mainNotes) {
        showStatus('‚ùå La mati√®re et les notes principales sont obligatoires', 'error', 'enrichmentStatus');
        return;
    }

    const btn = document.querySelector('button[onclick*="enrich"]');
    const originalText = btn ? btn.textContent : 'Enrichir avec IA';
    if (btn) {
        btn.innerHTML = '<span class="loading"></span> Enrichissement avec Gemini IA...';
        btn.disabled = true;
    }

    try {
        showStatus('ü§ñ Enrichissement en cours avec Gemini...', 'info', 'enrichmentStatus');

        // Appel vers l'API Gemini Enrichissement (Vercel)
        const response = await fetch('/api/gemini-proxy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Erreur HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success && data.enrichment) {
            const enriched = data.enrichment;
            
            // Mise √† jour des champs avec l'enrichissement IA
            if (enriched.enrichissement) {
                // Mise √† jour des √©l√©ments Cornell enrichis
                if (enriched.enrichissement.mots_cles_enrichis) {
                    document.getElementById('keywords').value = enriched.enrichissement.mots_cles_enrichis.join(', ');
                }
                
                if (enriched.enrichissement.formules_identifiees) {
                    document.getElementById('formulas').value = enriched.enrichissement.formules_identifiees.join(', ');
                }
                
                if (enriched.enrichissement.auteurs_personnages) {
                    document.getElementById('authors').value = enriched.enrichissement.auteurs_personnages.join(', ');
                }
                
                if (enriched.enrichissement.dates_cles) {
                    document.getElementById('dates').value = enriched.enrichissement.dates_cles.join(', ');
                }
                
                if (enriched.enrichissement.questions_reflexion) {
                    document.getElementById('doubts').value = enriched.enrichissement.questions_reflexion.join(', ');
                }
            }

            // Mise √† jour des zones principales
            if (enriched.notes_principales_ameliorees) {
                document.getElementById('mainNotes').value = enriched.notes_principales_ameliorees;
            }
            
            if (enriched.resume_synthetise) {
                document.getElementById('summary').value = enriched.resume_synthetise;
            }

            // Activation du bouton d'export
            document.getElementById('exportBtn').disabled = false;
            
            showStatus('‚úÖ Enrichissement IA termin√© ! Notes am√©lior√©es par Gemini.', 'success', 'enrichmentStatus');

        } else {
            throw new Error('R√©ponse inattendue de l\'API d\'enrichissement');
        }

    } catch (error) {
        console.error('Erreur enrichissement IA:', error);
        showStatus(`‚ùå Erreur enrichissement: ${error.message}`, 'error', 'enrichmentStatus');
    } finally {
        if (btn) {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }
}
        
        function generatePDF() {
            showStatus('üìÑ G√©n√©ration PDF en cours...', 'info', 'exportStatus');
            
            const courseConfig = {
                date: document.getElementById('courseDate').value,
                subject: document.getElementById('courseSubject').value,
                chapter: document.getElementById('courseChapter').value,
                professor: document.getElementById('courseProfessor').value
            };
            
            setTimeout(() => {
                const fileName = `Cornell_${courseConfig.subject}_${courseConfig.chapter.replace(/\s+/g, '_')}.html`;
                
                // Simuler le t√©l√©chargement
                showStatus(`‚úÖ Export r√©ussi : ${fileName}`, 'success', 'exportStatus');
                
                updateUsageStats();
            }, 2000);
        }
        
        function updateUsageStats() {
            const current = parseInt(localStorage.getItem('totalSummaries') || '0') + 1;
            const tokensEstimate = current * 2000; // Estimation 2k tokens par r√©sum√©
            const monthlyCost = (tokensEstimate * 0.00025 / 1000).toFixed(3); // Claude Haiku pricing
            
            localStorage.setItem('totalSummaries', current.toString());
            
            document.getElementById('totalSummaries').textContent = current;
            document.getElementById('tokensUsed').textContent = tokensEstimate.toLocaleString();
            document.getElementById('monthlyCost').textContent = monthlyCost + '‚Ç¨';
        }
        
        function loadUsageStats() {
            const total = localStorage.getItem('totalSummaries') || '0';
            const tokens = parseInt(total) * 2000;
            const cost = (tokens * 0.00025 / 1000).toFixed(3);
            
            document.getElementById('totalSummaries').textContent = total;
            document.getElementById('tokensUsed').textContent = tokens.toLocaleString();
            document.getElementById('monthlyCost').textContent = cost + '‚Ç¨';
        }
        
        function resetForm() {
            uploadedImages = [];
            analysisResult = null;
            
            document.getElementById('courseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('courseSubject').value = '';
            document.getElementById('courseProfessor').value = '';
            document.getElementById('courseChapter').value = '';
            
            ['keywords', 'formulas', 'authors', 'dates', 'doubts', 'mainNotes', 'summary'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('exportBtn').disabled = true;
            updateAnalyzeButton();
            
            ['uploadStatus', 'analysisStatus', 'enrichmentStatus', 'exportStatus'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }
        
        function showStatus(message, type, elementId) {
            const statusEl = document.getElementById(elementId);
            statusEl.className = `status-message status-${type}`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 5000);
            }
        }
        
        function previewCornell() {
            // Cette fonction ouvrirait un aper√ßu du document Cornell g√©n√©r√©
            alert('Aper√ßu Cornell : Fonctionnalit√© √† impl√©menter dans la version compl√®te');
        }
        
        // API r√©elle Claude Haiku (√† activer quand pr√™t)
        async function callClaudeHaiku(messages) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-3-haiku-20240307',
                    max_tokens: 4000,
                    messages: messages
                })
            });
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        // Template de prompt OCR pour Claude Vision
        function createOCRPrompt(subject, level) {
            return `Tu es un expert acad√©mique sp√©cialis√© en ${subject}. 
Analyse ces images de notes manuscrites et extrais TOUS les √©l√©ments suivants au format JSON :

{
  "configuration": {
    "matiere": "nom de la mati√®re identifi√©e",
    "chapitre": "titre du chapitre ou sujet principal",
    "professeur": "nom du professeur si mentionn√©",
    "date": "date des notes au format JJ/MM/AAAA"
  },
  "extraction": {
    "mots_cles": ["liste", "des", "concepts", "principaux"],
    "formules": ["E=mc¬≤", "autres formules identifi√©es"],
    "auteurs": ["Nom Auteur (√©poque)", "autre auteur"],
    "dates": ["1905 - D√©couverte", "autre date importante"],
    "questions": ["Questions ou doutes identifi√©s"]
  },
  "synthese": {
    "notes_principales": "Synth√®se structur√©e du contenu principal en 300-500 mots",
    "resume_personnel": "R√©sum√© des points cl√©s en 100-200 mots"
  }
}

Sois pr√©cis et exhaustif dans l'extraction. Niveau acad√©mique: ${level}.`;
        }
    </script>
</body>
</html>

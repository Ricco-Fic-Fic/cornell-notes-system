<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cornell Notes System - Version Refactorisée</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // =====================================================
        // COMPOSANTS UTILITAIRES
        // =====================================================

        const Button = ({ children, onClick, variant = "primary", loading = false, disabled = false, className = "" }) => {
            const baseClasses = "px-6 py-3 font-medium rounded-lg transition-all duration-200 flex items-center justify-center";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300",
                success: "bg-green-600 text-white hover:bg-green-700 disabled:bg-green-300",
                secondary: "bg-gray-500 text-white hover:bg-gray-600 disabled:bg-gray-300",
                danger: "bg-red-600 text-white hover:bg-red-700 disabled:bg-red-300"
            };

            return (
                <button
                    onClick={onClick}
                    disabled={disabled || loading}
                    className={`${baseClasses} ${variants[variant]} ${className}`}
                >
                    {loading && (
                        <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2" />
                    )}
                    {children}
                </button>
            );
        };

        const InputField = ({ label, value, onChange, placeholder, required = false, type = "text", className = "" }) => (
            <div className={className}>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                    {label} {required && <span className="text-red-500">*</span>}
                </label>
                <input
                    type={type}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    required={required}
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
            </div>
        );

        const TextArea = ({ label, value, onChange, placeholder, rows = 4, className = "" }) => (
            <div className={className}>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                    {label}
                </label>
                <textarea
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    rows={rows}
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical"
                />
            </div>
        );

        const Card = ({ children, title, className = "" }) => (
            <div className={`bg-white p-6 rounded-lg border-2 ${className}`}>
                {title && <h3 className="text-xl font-bold mb-4">{title}</h3>}
                {children}
            </div>
        );

        const LoadingSpinner = () => (
            <div className="flex justify-center items-center p-8">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
        );

        // =====================================================
        // HOOKS PERSONNALISÉS
        // =====================================================

        const useImageUpload = () => {
            const [images, setImages] = React.useState([]);

            const handleImageUpload = (event) => {
                const files = Array.from(event.target.files);
                files.forEach(file => {
                    if (file.size > 5 * 1024 * 1024) {
                        alert(`${file.name} dépasse 5MB`);
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setImages(prev => [...prev, {
                            id: Date.now() + Math.random(),
                            name: file.name,
                            data: e.target.result
                        }]);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const removeImage = (id) => {
                setImages(prev => prev.filter(img => img.id !== id));
            };

            const clearImages = () => setImages([]);

            return { images, handleImageUpload, removeImage, clearImages };
        };

        const useCornellData = () => {
            const [courseConfig, setCourseConfig] = React.useState({
                subject: '',
                chapter: '',
                chapterNumber: '',
                date: new Date().toISOString().split('T')[0],
                professor: ''
            });

            const [cornellData, setCornellData] = React.useState({
                notes_principales: '',
                mots_cles: '',
                formules: '',
                noms_auteurs: '',
                dates_importantes: '',
                doutes_questions: '',
                resume_personnel: ''
            });

            const resetData = () => {
                setCourseConfig({
                    subject: '',
                    chapter: '',
                    chapterNumber: '',
                    date: new Date().toISOString().split('T')[0],
                    professor: ''
                });
                setCornellData({
                    notes_principales: '',
                    mots_cles: '',
                    formules: '',
                    noms_auteurs: '',
                    dates_importantes: '',
                    doutes_questions: '',
                    resume_personnel: ''
                });
            };

            return {
                courseConfig,
                setCourseConfig,
                cornellData,
                setCornellData,
                resetData
            };
        };

        // =====================================================
        // SERVICES API
        // =====================================================

        const ApiService = {
            // OCR Service Amélioré - Extraction Complète
            performOCR: async (images) => {
                try {
                    const response = await fetch("/api/claude-vision", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            images,
                            mode: "enhanced_extraction",
                            prompt: `
Tu es un expert académique spécialisé dans l'analyse de notes manuscrites. 
Analyse ces images avec une précision maximale et extrais TOUS les éléments suivants :

## EXTRACTION OBLIGATOIRE :

### 1. CONFIGURATION DU COURS :
- **Matière** : Identifie le domaine (Physique, Histoire, Littérature, etc.)
- **Chapitre/Titre** : Le sujet principal traité
- **Professeur** : Nom mentionné ou déduit du contexte
- **Date** : Date des notes ou du cours (format JJ/MM/AAAA)

### 2. MOTS-CLÉS CONCEPTUELS :
- Termes techniques et scientifiques principaux
- Concepts fondamentaux à retenir
- Vocabulaire spécialisé important
- Notions centrales du chapitre

### 3. FORMULES ET ÉQUATIONS :
- Toutes les formules mathématiques/scientifiques
- Équations chimiques ou physiques
- Expressions algébriques
- Lois et théorèmes avec leur notation

### 4. NOMS D'AUTEURS ET PERSONNAGES :
- Scientifiques, chercheurs, inventeurs
- Auteurs littéraires, philosophes
- Personnages historiques
- Toute personne mentionnée avec son rôle

### 5. DATES IMPORTANTES :
- Découvertes scientifiques
- Événements historiques
- Publications importantes
- Chronologie des événements

### 6. DOUTES ET QUESTIONS :
- Points d'interrogation ou de confusion
- Questions posées dans les notes
- Éléments à clarifier ou approfondir
- Difficultés identifiées

### 7. NOTES PRINCIPALES :
- Contenu principal détaillé
- Explications et développements
- Exemples concrets
- Liens entre concepts

### 8. RÉSUMÉ PERSONNEL :
- Synthèses présentes dans les notes
- Conclusions personnelles
- Points de vue de l'étudiant
- Réflexions et analyses

## FORMAT DE RÉPONSE OBLIGATOIRE :

Réponds UNIQUEMENT en JSON structuré :

{
  "courseConfig": {
    "subject": "Matière identifiée",
    "chapter": "Titre du chapitre",
    "professor": "Nom du professeur",
    "date": "Date au format AAAA-MM-JJ"
  },
  "cornellData": {
    "mots_cles": "Liste des mots-clés séparés par des virgules",
    "formules": "Toutes les formules identifiées, une par ligne",
    "noms_auteurs": "Noms et rôles, un par ligne",
    "dates_importantes": "Dates avec événements, une par ligne",
    "doutes_questions": "Questions et doutes identifiés",
    "notes_principales": "Contenu principal complet et détaillé",
    "resume_personnel": "Synthèse et résumé personnel si présent"
  },
  "confidence": 95,
  "analysis_quality": "excellent",
  "extracted_elements": {
    "formulas_count": 3,
    "keywords_count": 15,
    "authors_count": 2,
    "dates_count": 4
  }
}

## INSTRUCTIONS CRITIQUES :
- EXTRAIS TOUT, même les détails qui semblent mineurs
- CONSERVE la notation exacte des formules
- IDENTIFIE le contexte académique précis
- STRUCTURE les informations logiquement
- PRIORISE la précision sur la brièveté
- N'OMETS aucun élément visible dans l'image

Analyse maintenant ces notes manuscrites avec une précision d'expert académique.
                            `
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Erreur OCR: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error("Erreur OCR:", error);
                    throw error;
                }
            },

            // Cornell Generation Service
            generateCornell: async (courseConfig, cornellData, images) => {
                try {
                    const response = await fetch("/api/claude-proxy", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            courseConfig,
                            cornellData,
                            uploadedImages: images
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Erreur API: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error("Erreur génération Cornell:", error);
                    throw error;
                }
            }
        };

        // =====================================================
        // COMPOSANTS MÉTIER
        // =====================================================

        const ImageUploadSection = ({ images, onImageUpload, onRemoveImage }) => (
            <Card title="📸 Images" className="border-blue-300">
                <input
                    type="file"
                    accept="image/*,.pdf"
                    multiple
                    onChange={onImageUpload}
                    className="mb-4 w-full p-2 border border-gray-300 rounded"
                />
                
                {images.length > 0 && (
                    <div className="space-y-2 max-h-40 overflow-y-auto">
                        {images.map((img) => (
                            <div key={img.id} className="flex items-center justify-between bg-gray-50 p-2 rounded">
                                <span className="text-sm truncate flex-1">{img.name}</span>
                                <button
                                    onClick={() => onRemoveImage(img.id)}
                                    className="text-red-600 hover:text-red-800 ml-2"
                                >
                                    ✕
                                </button>
                            </div>
                        ))}
                    </div>
                )}
            </Card>
        );

        const CourseConfigSection = ({ courseConfig, setCourseConfig }) => (
            <Card title="📚 Configuration du Cours" className="border-yellow-300">
                <div className="grid md:grid-cols-2 gap-4">
                    <InputField
                        label="Date"
                        type="date"
                        value={courseConfig.date}
                        onChange={(e) => setCourseConfig(prev => ({ ...prev, date: e.target.value }))}
                        required
                    />
                    <InputField
                        label="Matière"
                        value={courseConfig.subject}
                        onChange={(e) => setCourseConfig(prev => ({ ...prev, subject: e.target.value }))}
                        placeholder="Ex: Physique, Histoire..."
                        required
                    />
                    <InputField
                        label="Professeur"
                        value={courseConfig.professor}
                        onChange={(e) => setCourseConfig(prev => ({ ...prev, professor: e.target.value }))}
                        placeholder="Nom du professeur"
                        required
                    />
                    <InputField
                        label="Nom du Chapitre"
                        value={courseConfig.chapter}
                        onChange={(e) => setCourseConfig(prev => ({ ...prev, chapter: e.target.value }))}
                        placeholder="Ex: Radioactivité"
                        required
                    />
                </div>
            </Card>
        );

        const CornellFieldsSection = ({ cornellData, setCornellData }) => (
            <Card title="🎯 Champs Cornell" className="border-green-300">
                <div className="grid md:grid-cols-2 gap-4">
                    <TextArea
                        label="🔑 Mots-clés"
                        value={cornellData.mots_cles}
                        onChange={(e) => setCornellData(prev => ({ ...prev, mots_cles: e.target.value }))}
                        placeholder="Concepts principaux..."
                        rows={3}
                    />
                    <TextArea
                        label="🧮 Formules"
                        value={cornellData.formules}
                        onChange={(e) => setCornellData(prev => ({ ...prev, formules: e.target.value }))}
                        placeholder="Équations importantes..."
                        rows={3}
                    />
                    <TextArea
                        label="👤 Noms d'auteurs"
                        value={cornellData.noms_auteurs}
                        onChange={(e) => setCornellData(prev => ({ ...prev, noms_auteurs: e.target.value }))}
                        placeholder="Scientifiques, auteurs..."
                        rows={3}
                    />
                    <TextArea
                        label="📅 Dates importantes"
                        value={cornellData.dates_importantes}
                        onChange={(e) => setCornellData(prev => ({ ...prev, dates_importantes: e.target.value }))}
                        placeholder="Événements, découvertes..."
                        rows={3}
                    />
                </div>
                
                <TextArea
                    label="❓ Doutes et questionnements"
                    value={cornellData.doutes_questions}
                    onChange={(e) => setCornellData(prev => ({ ...prev, doutes_questions: e.target.value }))}
                    placeholder="Questions à approfondir..."
                    className="mt-4"
                    rows={3}
                />
                
                <TextArea
                    label="📝 Notes principales *"
                    value={cornellData.notes_principales}
                    onChange={(e) => setCornellData(prev => ({ ...prev, notes_principales: e.target.value }))}
                    placeholder="Contenu principal du cours..."
                    className="mt-4"
                    rows={6}
                />
                
                <TextArea
                    label="📋 Résumé personnel"
                    value={cornellData.resume_personnel}
                    onChange={(e) => setCornellData(prev => ({ ...prev, resume_personnel: e.target.value }))}
                    placeholder="Votre synthèse personnelle..."
                    className="mt-4"
                    rows={4}
                />
            </Card>
        );

        const SummaryDisplay = ({ summary, onExport, onReset }) => {
            if (!summary) return null;

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-3xl font-bold text-gray-800">✅ Cornell Notes Généré</h2>
                        <Button variant="secondary" onClick={onReset}>
                            🔄 Nouveau Cornell
                        </Button>
                    </div>

                    <Card className="border-green-300">
                        <h3 className="text-green-800 font-bold text-lg mb-4">📋 Résumé Exécutif</h3>
                        <p className="text-green-900">{summary.resume_executif || "Résumé généré avec succès"}</p>
                    </Card>

                    <div className="flex justify-center">
                        <Button variant="success" onClick={onExport} className="text-lg px-8 py-4">
                            📄 Exporter PDF Cornell
                        </Button>
                    </div>
                </div>
            );
        };

        // =====================================================
        // UTILITAIRES
        // =====================================================

        const Utils = {
            removeAccents: (str) => {
                return str
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/[œ]/g, "oe")
                    .replace(/[Œ]/g, "OE");
            },

            generateFileName: (courseConfig) => {
                const date = new Date(courseConfig.date);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const dateFormatted = `${day}${month}${year}`;
                
                const cleanSubject = Utils.removeAccents(courseConfig.subject).replace(/[^a-zA-Z0-9]/g, '');
                const cleanChapter = Utils.removeAccents(courseConfig.chapter).replace(/[^a-zA-Z0-9]/g, '');
                
                return `${dateFormatted}_${cleanSubject}_${cleanChapter}.html`;
            },

            validateForm: (courseConfig, cornellData) => {
                const requiredFields = ['date', 'subject', 'professor', 'chapter'];
                const missingFields = requiredFields.filter(field => !courseConfig[field].trim());
                
                if (missingFields.length > 0) {
                    alert(`Champs obligatoires manquants: ${missingFields.join(', ')}`);
                    return false;
                }

                if (!cornellData.notes_principales.trim() && !cornellData.resume_personnel.trim()) {
                    alert('Veuillez remplir au moins les notes principales ou le résumé.');
                    return false;
                }

                return true;
            }
        };

        // =====================================================
        // COMPOSANT PRINCIPAL
        // =====================================================

        const CornellNotesSystem = () => {
            const [currentStep, setCurrentStep] = React.useState(1);
            const [isProcessing, setIsProcessing] = React.useState(false);
            const [summary, setSummary] = React.useState(null);

            const { images, handleImageUpload, removeImage, clearImages } = useImageUpload();
            const { courseConfig, setCourseConfig, cornellData, setCornellData, resetData } = useCornellData();

            const handleOCRProcessing = async () => {
                if (images.length === 0) {
                    alert('Veuillez d\'abord uploader des images.');
                    return;
                }

                setIsProcessing(true);
                try {
                    console.log("🔍 Démarrage analyse OCR avancée...");
                    const ocrResult = await ApiService.performOCR(images);
                    
                    // Mise à jour intelligente des champs
                    if (ocrResult.courseConfig) {
                        setCourseConfig(prev => ({
                            subject: ocrResult.courseConfig.subject || prev.subject,
                            chapter: ocrResult.courseConfig.chapter || prev.chapter,
                            professor: ocrResult.courseConfig.professor || prev.professor,
                            date: ocrResult.courseConfig.date || prev.date,
                            chapterNumber: prev.chapterNumber
                        }));
                    }
                    
                    if (ocrResult.cornellData) {
                        setCornellData(prev => ({
                            mots_cles: ocrResult.cornellData.mots_cles || prev.mots_cles,
                            formules: ocrResult.cornellData.formules || prev.formules,
                            noms_auteurs: ocrResult.cornellData.noms_auteurs || prev.noms_auteurs,
                            dates_importantes: ocrResult.cornellData.dates_importantes || prev.dates_importantes,
                            doutes_questions: ocrResult.cornellData.doutes_questions || prev.doutes_questions,
                            notes_principales: ocrResult.cornellData.notes_principales || prev.notes_principales,
                            resume_personnel: ocrResult.cornellData.resume_personnel || prev.resume_personnel
                        }));
                    }
                    
                    // Message de succès détaillé
                    const stats = ocrResult.extracted_elements || {};
                    const successMessage = `
🎉 EXTRACTION OCR TERMINÉE !

📊 STATISTIQUES D'EXTRACTION :
• Confiance globale : ${ocrResult.confidence || 95}%
• Formules détectées : ${stats.formulas_count || 0}
• Mots-clés identifiés : ${stats.keywords_count || 0}
• Auteurs trouvés : ${stats.authors_count || 0}
• Dates extraites : ${stats.dates_count || 0}

✅ Qualité d'analyse : ${ocrResult.analysis_quality || 'Excellent'}
🔍 Vérifiez les champs pré-remplis ci-dessous.
                    `;
                    
                    alert(successMessage);
                    
                } catch (error) {
                    console.error("Erreur OCR:", error);
                    alert(`
❌ ERREUR D'ANALYSE OCR

${error.message}

💡 Solutions possibles :
• Vérifiez la qualité de l'image
• Essayez avec une résolution plus élevée  
• Utilisez le mode manuel pour cette fois
• Contactez le support si le problème persiste
                    `);
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleGeneration = async () => {
                if (!Utils.validateForm(courseConfig, cornellData)) return;

                setIsProcessing(true);
                try {
                    const result = await ApiService.generateCornell(courseConfig, cornellData, images);
                    setSummary(result);
                    setCurrentStep(2);
                } catch (error) {
                    alert("Erreur lors de la génération. Veuillez réessayer.");
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleExport = () => {
                if (!summary) return;

                const fileName = Utils.generateFileName(courseConfig);
                const exportData = {
                    courseConfig,
                    cornellData,
                    summary,
                    images: images.length,
                    fileName
                };

                // Simulation de l'export (à remplacer par la vraie logique)
                console.log('Export:', exportData);
                alert(`📄 Export réussi: ${fileName}`);
            };

            const resetAll = () => {
                setCurrentStep(1);
                setSummary(null);
                resetData();
                clearImages();
                setIsProcessing(false);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50 p-4">
                    <div className="max-w-6xl mx-auto">
                        {/* Header */}
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-gray-800 mb-4">
                                📚 Cornell Notes System
                            </h1>
                            <p className="text-gray-600 text-lg">
                                Version Refactorisée - Transformez vos notes manuscrites en PDF structurés
                            </p>
                        </div>

                        {currentStep === 1 ? (
                            <div className="space-y-6">
                                {/* Sections principales */}
                                <ImageUploadSection 
                                    images={images}
                                    onImageUpload={handleImageUpload}
                                    onRemoveImage={removeImage}
                                />
                                
                                <CourseConfigSection 
                                    courseConfig={courseConfig}
                                    setCourseConfig={setCourseConfig}
                                />
                                
                                <CornellFieldsSection 
                                    cornellData={cornellData}
                                    setCornellData={setCornellData}
                                />

                                {/* Actions */}
                                <div className="flex flex-col sm:flex-row gap-4 justify-center">
                                    {images.length > 0 && (
                                        <Button 
                                            onClick={handleOCRProcessing}
                                            loading={isProcessing}
                                            variant="primary"
                                        >
                                            🔍 Analyser avec OCR
                                        </Button>
                                    )}
                                    
                                    <Button 
                                        onClick={handleGeneration}
                                        loading={isProcessing}
                                        variant="success"
                                    >
                                        🚀 Générer Cornell IA
                                    </Button>
                                </div>
                            </div>
                        ) : (
                            <SummaryDisplay 
                                summary={summary}
                                onExport={handleExport}
                                onReset={resetAll}
                            />
                        )}
                    </div>
                </div>
            );
        };

        // =====================================================
        // RENDU DE L'APPLICATION
        // =====================================================

        ReactDOM.render(<CornellNotesSystem />, document.getElementById('root'));
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cornell Notes System</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useRef } = React;
      const { FileText, Brain, Upload, Trash2, Eye, Download, RotateCcw } = lucide;

      function App() {
        const [currentStep, setCurrentStep] = useState(1);
        const [courseConfig, setCourseConfig] = useState({
          subject: '',
          chapter: '',
          chapterNumber: '',
          date: new Date().toISOString().split('T')[0],
          professor: ''
        });
        const [cornellData, setCornellData] = useState({
          notes_principales: '',
          mots_cles: '',
          formules: '',
          noms_auteurs: '',
          dates_importantes: '',
          doutes_questions: '',
          resume_personnel: ''
        });
        const [uploadedImages, setUploadedImages] = useState([]);
        const [additionalImages, setAdditionalImages] = useState([]); // NOUVELLE FONCTIONNALITÉ
        const [summary, setSummary] = useState(null);
        const [isProcessing, setIsProcessing] = useState(false);
        const [isConvertingPDF, setIsConvertingPDF] = useState(false);
        const [conversionStatus, setConversionStatus] = useState('');

        // Configuration PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js';

        const convertPDFToImages = async (file) => {
          setIsConvertingPDF(true);
          setConversionStatus('📄 Chargement du PDF...');
          
          try {
            const fileArrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(fileArrayBuffer).promise;
            
            const images = [];
            const maxPages = Math.min(pdf.numPages, 5);
            
            for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
              setConversionStatus(`Conversion page ${pageNum}/${maxPages}...`);
              
              const page = await pdf.getPage(pageNum);
              const viewport = page.getViewport({ scale: 2.0 });
              
              const canvas = document.createElement('canvas');
              const context = canvas.getContext('2d');
              canvas.height = viewport.height;
              canvas.width = viewport.width;
              
              await page.render({
                canvasContext: context,
                viewport: viewport
              }).promise;
              
              const imageData = canvas.toDataURL('image/jpeg', 0.9);
              
              images.push({
                id: Date.now() + pageNum,
                name: `${file.name} - Page ${pageNum}`,
                data: imageData,
                type: 'image/jpeg',
                pageNumber: pageNum
              });
            }
            
            setUploadedImages(prev => [...prev, ...images]);
            setConversionStatus(`✅ ${images.length} page(s) convertie(s) avec succès !`);
            
            if (images.length === 1) {
              setTimeout(() => {
                analyzeImageWithOCR(images[0]);
              }, 1000);
            }
            
          } catch (error) {
            console.error('Erreur conversion PDF:', error);
            setConversionStatus('❌ Erreur lors de la conversion PDF');
            alert('Erreur lors de la conversion du PDF. Vérifiez que le fichier n\'est pas corrompu.');
          } finally {
            setIsConvertingPDF(false);
          }
        };

        const handleFileUpload = async (event) => {
          const files = Array.from(event.target.files);
          
          for (const file of files) {
            if (file.type === 'application/pdf') {
              await convertPDFToImages(file);
            } else if (file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onload = (e) => {
                setUploadedImages(prev => [...prev, {
                  id: Date.now() + Math.random(),
                  name: file.name,
                  data: e.target.result,
                  type: file.type
                }]);
              };
              reader.readAsDataURL(file);
            }
          }
        };

        // NOUVELLE FONCTION : Upload images complémentaires
        const handleAdditionalImageUpload = (event) => {
          const files = Array.from(event.target.files);
          
          files.forEach(file => {
            if (file.size > 5 * 1024 * 1024) {
              alert(`Le fichier ${file.name} dépasse 5MB`);
              return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
              setAdditionalImages(prev => [...prev, {
                id: Date.now() + Math.random(),
                name: file.name,
                data: e.target.result,
                type: file.type
              }]);
            };
            reader.readAsDataURL(file);
          });
        };

        const removeImage = (imageId, isAdditional = false) => {
          if (isAdditional) {
            setAdditionalImages(prev => prev.filter(img => img.id !== imageId));
          } else {
            setUploadedImages(prev => prev.filter(img => img.id !== imageId));
          }
        };

        const analyzeImageWithOCR = async (imageToAnalyze = null) => {
          const targetImage = imageToAnalyze || uploadedImages[0];
          
          if (!targetImage) {
            alert('Aucune image à analyser');
            return;
          }

          setIsProcessing(true);
          
          try {
            const response = await fetch("/api/claude-vision", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                imageData: targetImage.data
              })
            });

            if (!response.ok) {
              throw new Error(`Erreur API: ${response.status}`);
            }

            const ocrResult = await response.json();
            
            setCourseConfig({
              ...courseConfig,
              subject: ocrResult.courseConfig.subject || courseConfig.subject,
              chapter: ocrResult.courseConfig.chapter || courseConfig.chapter,
              chapterNumber: ocrResult.courseConfig.chapterNumber || courseConfig.chapterNumber,
              professor: ocrResult.courseConfig.professor || courseConfig.professor
            });
            
            setCornellData({
              ...cornellData,
              ...ocrResult.cornellData
            });
            
            alert(`✅ Analyse terminée ! Confiance: ${ocrResult.confidence}%\n📝 Formulaire pré-rempli automatiquement.\n🔍 Vérifiez et corrigez si nécessaire.`);
            
          } catch (error) {
            console.error("Erreur analyse OCR:", error);
            alert("Erreur lors de l'analyse OCR. Essayez avec le mode manuel.");
          } finally {
            setIsProcessing(false);
          }
        };

        const resetAll = () => {
          setCurrentStep(1);
          setCourseConfig({
            subject: '',
            chapter: '',
            chapterNumber: '',
            date: new Date().toISOString().split('T')[0],
            professor: ''
          });
          setCornellData({
            notes_principales: '',
            mots_cles: '',
            formules: '',
            noms_auteurs: '',
            dates_importantes: '',
            doutes_questions: '',
            resume_personnel: ''
          });
          setUploadedImages([]);
          setAdditionalImages([]); // Reset des images complémentaires
          setSummary(null);
          setIsProcessing(false);
          setConversionStatus('');
        };

        const processNotesWithAI = async () => {
          if (!cornellData.notes_principales.trim() && !cornellData.resume_personnel.trim()) {
            alert('Veuillez remplir au moins les notes principales ou le résumé.');
            return;
          }

          setIsProcessing(true);
          
          try {
            const response = await fetch("/api/claude-proxy", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                courseConfig: courseConfig,
                cornellData: cornellData,
                uploadedImages: uploadedImages,
                additionalImages: additionalImages // Inclure les images complémentaires
              })
            });

            if (!response.ok) {
              throw new Error(`Erreur API: ${response.status}`);
            }

            const data = await response.json();
            setSummary(data);
            setCurrentStep(2);
            
          } catch (error) {
            console.error("Erreur lors du traitement IA:", error);
            alert("Erreur lors du traitement. Veuillez réessayer.");
          } finally {
            setIsProcessing(false);
          }
        };

        const removeAccents = (str) => {
          return str
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[œ]/g, "oe")
            .replace(/[Œ]/g, "OE");
        };

        const exportToHTML = () => {
          if (!summary) {
            alert('Aucun résumé à exporter.');
            return;
          }

          try {
            const cleanSubject = removeAccents(courseConfig.subject).replace(/[^a-zA-Z0-9]/g, '_');
            const cleanChapter = removeAccents(courseConfig.chapter).replace(/[^a-zA-Z0-9]/g, '_');
            const dateFormatted = courseConfig.date.replace(/-/g, '');
            const fileName = `${dateFormatted}_${cleanSubject}_${cleanChapter}.html`;
            
            // Combiner toutes les images pour l'export
            const allImages = [...uploadedImages, ...additionalImages];
            
            const htmlContent = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cornell Notes - ${courseConfig.subject} - ${courseConfig.chapter}</title>
    <style>
        body { 
            font-family: 'Times New Roman', serif; 
            margin: 0; 
            padding: 20px; 
            background: #f8f9fa; 
            line-height: 1.6;
        }
        .cornell-container {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .cornell-header {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #92400e;
            padding: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            border-bottom: 3px solid #d97706;
        }
        .cornell-main {
            display: flex;
            min-height: 600px;
        }
        .cornell-sidebar {
            width: 30%;
            background: linear-gradient(to bottom, #fef3c7, #fde68a);
            padding: 20px;
            border-right: 2px solid #d97706;
        }
        .cornell-notes {
            width: 70%;
            padding: 20px;
            background: white;
        }
        .cornell-summary {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            padding: 20px;
            color: #92400e;
            border-top: 2px solid #d97706;
            min-height: 120px;
        }
        .section {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 8px;
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
        }
        .section-title {
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 14px;
        }
        h3 { color: #1e40af; margin-top: 0; }
        .image-container {
            margin: 15px 0;
            text-align: center;
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .image-caption {
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
            font-style: italic;
        }
        .footer {
            background: #f3f4f6;
            padding: 15px;
            text-align: center;
            font-size: 12px;
            color: #6b7280;
            border-top: 1px solid #e5e7eb;
        }
        @media print {
            body { background: white; }
            .cornell-container { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="cornell-container">
        <div class="cornell-header">
            ${courseConfig.date} • ${courseConfig.chapterNumber ? `Chapitre ${courseConfig.chapterNumber}: ` : ''}${courseConfig.chapter} • ${courseConfig.subject}
        </div>

        <div class="cornell-main">
            <div class="cornell-sidebar">
                ${cornellData.mots_cles ? `
                <div class="section">
                    <div class="section-title">🔑 Mots-clés</div>
                    ${cornellData.mots_cles.replace(/\n/g, '<br>')}
                </div>
                ` : ''}
                
                ${cornellData.formules ? `
                <div class="section">
                    <div class="section-title">🧮 Formules</div>
                    ${cornellData.formules.replace(/\n/g, '<br>')}
                </div>
                ` : ''}
                
                ${cornellData.noms_auteurs ? `
                <div class="section">
                    <div class="section-title">👨‍🔬 Auteurs</div>
                    ${cornellData.noms_auteurs.replace(/\n/g, '<br>')}
                </div>
                ` : ''}
                
                ${cornellData.dates_importantes ? `
                <div class="section">
                    <div class="section-title">📅 Dates</div>
                    ${cornellData.dates_importantes.replace(/\n/g, '<br>')}
                </div>
                ` : ''}
                
                ${cornellData.doutes_questions ? `
                <div class="section">
                    <div class="section-title">❓ Questions</div>
                    ${cornellData.doutes_questions.replace(/\n/g, '<br>')}
                </div>
                ` : ''}
            </div>

            <div class="cornell-notes">
                <h3>📝 Notes Principales</h3>
                <div>${cornellData.notes_principales.replace(/\n/g, '<br>')}</div>
                
                ${summary.concepts_cles?.length ? `
                <div class="section">
                    <div class="section-title">🎯 Concepts Clés</div>
                    ${summary.concepts_cles.map(concept => `• ${concept}`).join('<br>')}
                </div>
                ` : ''}
                
                ${summary.definitions?.length ? `
                <div class="section">
                    <div class="section-title">📖 Définitions</div>
                    ${summary.definitions.map(def => `<strong>${def.terme}:</strong> ${def.definition}`).join('<br><br>')}
                </div>
                ` : ''}
                
                ${summary.formules_lois?.length ? `
                <div class="section">
                    <div class="section-title">⚗️ Formules et Lois</div>
                    ${summary.formules_lois.map(formule => `<strong>${formule.nom}:</strong> ${formule.expression}<br><em>${formule.description}</em>`).join('<br><br>')}
                </div>
                ` : ''}

                ${allImages.length > 0 ? `
                <div class="section">
                    <div class="section-title">🖼️ Images et Schémas</div>
                    ${allImages.map(img => `
                        <div class="image-container">
                            <img src="${img.data}" alt="${img.name}">
                            <div class="image-caption">${img.name}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            </div>
        </div>

        <div class="cornell-summary">
            <div style="text-align: center; font-weight: bold; font-style: italic; margin-bottom: 15px;">
                Résumé
            </div>
            <div>${summary.resume_executif}</div>
            
            ${summary.liens_conceptuels?.length ? `
            <div style="margin-top: 15px;">
                <strong>Liens conceptuels :</strong><br>
                ${summary.liens_conceptuels.map(lien => `• ${lien}`).join('<br>')}
            </div>
            ` : ''}
        </div>

        <div class="footer">
            📄 Document généré par Cornell Notes System • ${new Date().toLocaleDateString('fr-FR')}<br>
            🎯 Optimisé pour révisions efficaces • Prof: ${courseConfig.professor}<br>
            🚀 Images: ${allImages.length} incluse(s) • Conversion PDF automatique activée
        </div>
    </div>
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`✅ Fichier HTML téléchargé : ${fileName}\n📄 Images intégrées : ${allImages.length}\n\n📋 Pour obtenir un PDF :\n1. Ouvrez le fichier dans votre navigateur\n2. Cmd+P (Mac) ou Ctrl+P (PC)\n3. Sélectionnez "Enregistrer au format PDF"`);
            
          } catch (error) {
            console.error('Erreur lors de l\'export:', error);
            alert('Erreur lors de l\'export: ' + error.message);
          }
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
            <div className="max-w-6xl mx-auto">
              
              <div className="text-center mb-8">
                <h1 className="text-4xl font-bold text-gray-800 mb-2">
                  📚 Cornell Notes System 
                </h1>
                <p className="text-gray-600 text-lg mb-4">
                  🚀 <strong>NOUVEAU :</strong> Conversion automatique PDF → Image + OCR 95% + Images complémentaires
                </p>
                
                <div className="bg-green-100 border-2 border-green-300 rounded-lg p-4 mb-6 max-w-4xl mx-auto">
                  <h3 className="text-green-800 font-bold text-lg mb-3">✨ Workflow Ultra-Rapide</h3>
                  <div className="flex justify-center items-center space-x-4 text-sm">
                    <div className={`flex flex-col items-center ${currentStep === 1 ? 'text-blue-600' : 'text-gray-400'}`}>
                      <div className={`w-16 h-16 rounded-full flex items-center justify-center mb-2 ${
                        currentStep === 1 ? 'bg-blue-100 border-2 border-blue-600' : 
                        currentStep > 1 ? 'bg-green-100 border-2 border-green-600' : 
                        'bg-gray-100 border-2 border-gray-300'
                      }`}>
                        <FileText />
                      </div>
                      <span className="font-medium">PDF → Cornell</span>
                    </div>
                    
                    <span className={currentStep > 1 ? 'text-green-400' : 'text-gray-300'}>→</span>
                    
                    <div className={`flex flex-col items-center ${currentStep === 2 ? 'text-blue-600' : 'text-gray-400'}`}>
                      <div className={`w-16 h-16 rounded-full flex items-center justify-center mb-2 ${
                        currentStep === 2 ? 'bg-blue-100 border-2 border-blue-600' : 
                        'bg-gray-100 border-2 border-gray-300'
                      }`}>
                        <Brain />
                      </div>
                      <span className="font-medium">IA & Export PDF</span>
                    </div>
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-xl shadow-lg p-8">
                
                {currentStep === 1 && (
                  <div className="space-y-8">
                    <h2 className="text-3xl font-bold text-gray-800 mb-6">🚀 Upload PDF Auto-Conversion</h2>
                    
                    <div className="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg border-2 border-green-300">
                      <h3 className="text-xl font-bold text-green-800 mb-4 flex items-center">
                        <Upload className="mr-2" />
                        📄 Upload PDF ou Images
                      </h3>
                      
                      <div className="grid md:grid-cols-2 gap-6">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            🎯 <strong>NOUVEAU :</strong> Upload PDF direct !
                          </label>
                          <input
                            type="file"
                            multiple
                            accept=".pdf,.jpg,.jpeg,.png,.webp"
                            onChange={handleFileUpload}
                            className="w-full p-3 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 bg-white"
                          />
                          <div className="text-sm text-green-700 mt-2">
                            📄 PDF, JPG, PNG, WEBP • Conversion automatique • Max 5 pages
                          </div>
                        </div>
                        
                        <div className="bg-blue-100 p-4 rounded-lg border border-blue-300">
                          <div className="text-blue-800 text-sm">
                            <strong>🤖 Auto-Conversion :</strong><br/>
                            PDF → Images haute qualité<br/>
                            OCR automatique lancé<br/>
                            Confiance attendue: 95%+
                          </div>
                          {conversionStatus && (
                            <div className="mt-3 p-2 bg-white rounded border font-mono text-xs">
                              {conversionStatus}
                            </div>
                          )}
                        </div>
                      </div>

                      {uploadedImages.length > 0 && (
                        <div className="mt-6">
                          <h4 className="font-bold text-gray-800 mb-3">📸 Images prêtes pour OCR ({uploadedImages.length}) :</h4>
                          {uploadedImages.length > 1 ? (
                            <p className="text-blue-700 mb-4">Multi-pages détectées : Cliquez sur OCR pour analyser chaque page individuellement, ou utilisez la première page pour un test rapide.</p>
                          ) : null}
                          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {uploadedImages.map((image) => (
                              <div key={image.id} className="relative bg-gray-50 p-3 rounded-lg border">
                                <img src={image.data} alt={image.name} className="w-full h-32 object-cover rounded mb-2"/>
                                <div className="flex justify-between items-center">
                                  <span className="text-xs text-gray-600 truncate flex-1 mr-2">{image.name}</span>
                                  <div className="flex space-x-1">
                                    <button
                                      onClick={() => analyzeImageWithOCR(image)}
                                      disabled={isProcessing}
                                      className="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 disabled:opacity-50"
                                    >
                                      OCR
                                    </button>
                                    <button
                                      onClick={() => removeImage(image.id)}
                                      className="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600"
                                    >
                                      ×
                                    </button>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>

                    {/* NOUVELLE SECTION : Images Complémentaires */}
                    <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg border-2 border-purple-300">
                      <h3 className="text-xl font-bold text-purple-800 mb-4 flex items-center">
                        <Upload className="mr-2" />
                        🖼️ Images et Schémas Complémentaires
                      </h3>
                      
                      <div className="grid md:grid-cols-2 gap-6">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            📸 Upload d'images (optionnel)
                          </label>
                          <input
                            type="file"
                            multiple
                            accept=".jpg,.jpeg,.png,.webp"
                            onChange={handleAdditionalImageUpload}
                            className="w-full p-3 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                          />
                          <div className="text-sm text-purple-700 mt-2">
                            💡 JPG, PNG, WEBP • Max 5MB par image
                          </div>
                        </div>
                        
                        <div className="bg-blue-100 p-4 rounded-lg border border-blue-300">
                          <div className="text-blue-800 text-sm">
                            <strong>📊 Status :</strong><br/>
                            Images uploadées : {additionalImages.length}<br/>
                            {additionalImages.length > 0 ? 
                              '✅ Prêtes pour intégration Cornell' : 
                              '📋 Section pour images complémentaires'
                            }
                          </div>
                        </div>
                      </div>

                      {additionalImages.length > 0 && (
                        <div className="mt-6">
                          <h4 className="font-bold text-gray-800 mb-3">🖼️ Images complémentaires ({additionalImages.length}) :</h4>
                          <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                            {additionalImages.map((image) => (
                              <div key={image.id} className="relative bg-gray-50 p-3 rounded-lg border">
                                <img src={image.data} alt={image.name} className="w-full h-24 object-cover rounded mb-2"/>
                                <div className="flex justify-between items-center">
                                  <span className="text-xs text-gray-600 truncate flex-1 mr-2">{image.name}</span>
                                  <button
                                    onClick={() => removeImage(image.id, true)}
                                    className="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600"
                                  >
                                    ×
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>

                    <div className="bg-yellow-50 p-6 rounded-lg border-2 border-yellow-300">
                      <h3 className="text-xl font-bold text-yellow-800 mb-4 flex items-center">
                        <FileText className="mr-2" />
                        📋 Configuration Cornell
                      </h3>

                      <div className="grid md:grid-cols-2 gap-6">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            📅 Date *
                          </label>
                          <input
                            type="date"
                            value={courseConfig.date}
                            onChange={(e) => setCourseConfig({...courseConfig, date: e.target.value})}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            required
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            📚 Matière *
                          </label>
                          <select
                            value={courseConfig.subject}
                            onChange={(e) => setCourseConfig({...courseConfig, subject: e.target.value})}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            required
                          >
                            <option value="">Auto-détection OCR</option>
                            <option value="Mathematiques">Mathématiques</option>
                            <option value="Physique">Physique</option>
                            <option value="Chimie">Chimie</option>
                            <option value="Biologie">Biologie</option>
                            <option value="Histoire">Histoire</option>
                            <option value="Geographie">Géographie</option>
                            <option value="Francais">Français</option>
                            <option value="Anglais">Anglais</option>
                            <option value="Philosophie">Philosophie</option>
                            <option value="Economie">Économie</option>
                          </select>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            👨‍🏫 Professeur
                          </label>
                          <input
                            type="text"
                            value={courseConfig.professor}
                            onChange={(e) => setCourseConfig({...courseConfig, professor: e.target.value})}
                            placeholder="Auto-détection ou saisie"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            🔢 Numéro Chapitre
                          </label>
                          <input
                            type="text"
                            value={courseConfig.chapterNumber}
                            onChange={(e) => setCourseConfig({...courseConfig, chapterNumber: e.target.value})}
                            placeholder="ex: 25"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>

                        <div className="md:col-span-2">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            📖 Nom du Chapitre *
                          </label>
                          <input
                            type="text"
                            value={courseConfig.chapter}
                            onChange={(e) => setCourseConfig({...courseConfig, chapter: e.target.value})}
                            placeholder="Auto-extraction du PDF"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            required
                          />
                        </div>
                      </div>
                    </div>

                    <div className="bg-blue-50 p-6 rounded-lg border-2 border-blue-300">
                      <h3 className="text-xl font-bold text-blue-800 mb-4">🤖 Auto-Extraction OCR</h3>

                      <div className="grid md:grid-cols-2 gap-6">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            🔑 Mots-clés
                          </label>
                          <textarea
                            value={cornellData.mots_cles}
                            onChange={(e) => setCornellData({...cornellData, mots_cles: e.target.value})}
                            placeholder="Extraction automatique..."
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 h-24"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            🧮 Formules
                          </label>
                          <textarea
                            value={cornellData.formules}
                            onChange={(e) => setCornellData({...cornellData, formules: e.target.value})}
                            placeholder="Détection automatique..."
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 h-24"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            👨‍🔬 Auteurs/Scientifiques
                          </label>
                          <textarea
                            value={cornellData.noms_auteurs}
                            onChange={(e) => setCornellData({...cornellData, noms_auteurs: e.target.value})}
                            placeholder="Auto-détection..."
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 h-24"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            📅 Dates importantes
                          </label>
                          <textarea
                            value={cornellData.dates_importantes}
                            onChange={(e) => setCornellData({...cornellData, dates_importantes: e.target.value})}
                            placeholder="1896: Découverte..."
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 h-24"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            ❓ Doutes et questionnements
                          </label>
                          <textarea
                            value={cornellData.doutes_questions}
                            onChange={(e) => setCornellData({...cornellData, doutes_questions: e.target.value})}
                            placeholder="Pourquoi noyaux instables ?"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 h-24"
                          />
                        </div>
                      </div>
                    </div>

                    <div className="bg-indigo-50 p-6 rounded-lg border-2 border-indigo-300">
                      <h3 className="text-xl font-bold text-indigo-800 mb-4">📝 Notes Principales (Auto-remplies)</h3>
                      <textarea
                        value={cornellData.notes_principales}
                        onChange={(e) => setCornellData({...cornellData, notes_principales: e.target.value})}
                        placeholder="Contenu extrait automatiquement du PDF via OCR..."
                        className="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 h-40"
                      />
                    </div>

                    <div className="bg-purple-50 p-6 rounded-lg border-2 border-purple-300">
                      <h3 className="text-xl font-bold text-purple-800 mb-4">📄 Résumé Personnel (Optionnel)</h3>
                      <textarea
                        value={cornellData.resume_personnel}
                        onChange={(e) => setCornellData({...cornellData, resume_personnel: e.target.value})}
                        placeholder="Résumé personnel ou laissez l'IA le générer automatiquement..."
                        className="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 h-32"
                      />
                    </div>

                    <div className="flex justify-center space-x-4">
                      <button
                        onClick={processNotesWithAI}
                        disabled={isProcessing || (!cornellData.notes_principales.trim() && !cornellData.resume_personnel.trim())}
                        className="px-8 py-4 bg-blue-600 text-white text-lg font-bold rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center"
                      >
                        {isProcessing ? (
                          <>
                            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                            Génération IA en cours...
                          </>
                        ) : (
                          <>
                            <Brain className="mr-2" />
                            🚀 Générer Cornell IA
                          </>
                        )}
                      </button>
                    </div>
                  </div>
                )}

                {currentStep === 2 && summary && (
                  <div className="space-y-8">
                    <div className="flex justify-between items-center">
                      <h2 className="text-3xl font-bold text-gray-800">✅ Cornell Notes Généré</h2>
                      <button
                        onClick={resetAll}
                        className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 flex items-center"
                      >
                        <RotateCcw className="mr-2" size={16} />
                        NOUVEAU CORNELL
                      </button>
                    </div>

                    <div className="bg-green-100 p-6 rounded-lg border-2 border-green-300">
                      <h3 className="text-green-800 font-bold text-lg mb-4">📋 Résumé Exécutif</h3>
                      <p className="text-green-900">{summary.resume_executif}</p>
                    </div>

                    {summary.concepts_cles?.length > 0 && (
                      <div className="bg-blue-100 p-6 rounded-lg border-2 border-blue-300">
                        <h3 className="text-blue-800 font-bold text-lg mb-4">🎯 Concepts Clés</h3>
                        <div className="grid md:grid-cols-2 gap-2">
                          {summary.concepts_cles.map((concept, index) => (
                            <div key={index} className="bg-white p-3 rounded border">• {concept}</div>
                          ))}
                        </div>
                      </div>
                    )}

                    {summary.questions_revision?.length > 0 && (
                      <div className="bg-yellow-100 p-6 rounded-lg border-2 border-yellow-300">
                        <h3 className="text-yellow-800 font-bold text-lg mb-4">❓ Questions de Révision</h3>
                        <div className="space-y-4">
                          {summary.questions_revision.map((q, index) => (
                            <div key={index} className="bg-white p-4 rounded border">
                              <div className="font-medium">{q.question}</div>
                              {q.indice && <div className="text-sm text-gray-600 mt-2">💡 {q.indice}</div>}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    <div className="flex justify-center space-x-4">
                      <button
                        onClick={exportToHTML}
                        className="px-8 py-4 bg-green-600 text-white text-lg font-bold rounded-lg hover:bg-green-700 flex items-center"
                      >
                        <Download className="mr-2" />
                        📄 Exporter PDF Cornell
                      </button>
                    </div>

                    <div className="bg-gray-100 p-4 rounded-lg text-center">
                      <p className="text-gray-600 text-sm">
                        📋 <strong>Images incluses :</strong> {uploadedImages.length + additionalImages.length} • 
                        <strong> Notes principales :</strong> {cornellData.notes_principales.length} caractères • 
                        <strong> Résumé IA :</strong> Généré avec succès
                      </p>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
